<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Writing Practice with Hemiya AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* Base styles from frenchinterview.html */
        :root {
            --primary-color: #00FF99;
            --bg-color: #121212;
            --text-color: #00FF99;
            --card-bg: rgba(0, 255, 153, 0.2);
            --font-family: 'Poppins', sans-serif;
        }

        * {
            font-family: var(--font-family);
        }

        body {
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            box-shadow: 0 0 30px var(--primary-color);
            position: relative;
        }

        /* Add the glowing border effect */
        body::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 22px;
            background: linear-gradient(45deg, 
                var(--primary-color) 0%, 
                transparent 50%,
                var(--primary-color) 100%
            );
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite;
        }

        /* Step indicators */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 20px;
        }

        .step {
            padding: 10px 20px;
            border-radius: 10px;
            background: var(--card-bg);
            border: 1px solid var(--primary-color);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .step.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--primary-color);
        }

        /* Intro container styles */
        .intro-container {
            background: rgba(0, 255, 153, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px auto;
            max-width: 800px;
            display: flex;
            align-items: center;
            gap: 30px;
            border: 1px solid var(--primary-color, #00FF99);
            box-shadow: 0 0 20px rgba(0, 255, 153, 0.2);
        }

        .intro-container:hover {
            box-shadow: 0 0 30px rgba(0, 255, 153, 0.5);
        }

        .ai-avatar {
            flex-shrink: 0;
            position: relative;
            cursor: pointer;
        }

        .ai-avatar::before {
            content: '✨';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            animation: sparkle 2s infinite;
        }

        .ai-avatar::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-color) 0%, transparent 70%);
            animation: glowRing 3s infinite;
            z-index: -1;
        }

        .avatar-img {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            border: 2px solid var(--primary-color, #00FF99);
            box-shadow: 0 0 15px var(--primary-color, #00FF99);
            object-fit: cover;
            animation: pulse 3s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        .avatar-img:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 
                0 0 20px var(--primary-color),
                0 0 40px var(--primary-color),
                0 0 60px var(--primary-color);
        }

        /* Topic selection styles */
        .topic-box {
            font-size: 22px;
            padding: 20px;
            background: rgba(0, 255, 153, 0.3);
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0px 0px 18px #00FF99;
            text-align: center;
            animation: glow 1.5s infinite alternate;
        }

        /* Writing area styles */
        .editor {
            width: 90%;
            max-width: 800px;
            height: 400px;
            border: 3px solid var(--primary-color);
            padding: 20px;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.4);
            color: white !important;
            outline: none;
            border-radius: 15px;
            margin: 20px auto;
            box-shadow: 0px 0px 15px var(--primary-color);
            transition: 0.3s ease-in-out;
        }

        /* Button styles */
        button {
            margin: 10px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: 0.3s ease-in-out;
            font-weight: bold;
        }

        .btn-green {
            background-color: var(--primary-color);
            color: black;
            box-shadow: 0px 0px 15px var(--primary-color);
        }

        .btn-red {
            background-color: #FF4444;
            color: white;
            box-shadow: 0px 0px 15px #FF4444;
        }

        .btn-blue {
            background-color: #0095ff;
            color: white;
            box-shadow: 0px 0px 15px #0095ff;
        }

        button:hover {
            transform: scale(1.1);
            box-shadow: 0px 0px 25px white;
        }

        /* Contact form overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .contact-form {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 255, 153, 0.25);
            width: 90%;
            max-width: 500px;
            padding: 32px;
            margin: 20px;
            border: 2px solid rgba(0, 255, 153, 0.2);
            position: relative;
            animation: formSlideIn 0.5s ease-out;
        }

        .contact-form input,
        .contact-form select {
            width: 100%;
            padding: 14px 16px;
            margin: 8px 0 20px 0;
            border-radius: 12px;
            border: 2px solid rgba(0, 255, 153, 0.2);
            background: rgba(0, 255, 153, 0.05);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }

        .contact-form input:focus,
        .contact-form select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 255, 153, 0.1);
            background: rgba(0, 255, 153, 0.1);
        }

        .contact-form input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .contact-form label {
            display: block;
            margin-bottom: 6px;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .contact-form button[type="submit"] {
            width: 100%;
            padding: 16px;
            margin-top: 24px;
            border-radius: 12px;
            background: var(--primary-color);
            color: #000;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .contact-form button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px var(--primary-color);
        }

        .contact-form button[type="submit"]:active {
            transform: translateY(0);
        }

        .form-intro {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(0, 255, 153, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(0, 255, 153, 0.1);
        }

        .intro-message h2 {
            font-size: 24px;
            margin-bottom: 8px;
            background: linear-gradient(45deg, var(--primary-color), #00ffcc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .intro-message p {
            font-size: 15px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .form-group {
            margin-bottom: 16px;
            position: relative;
        }

        .form-group .icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            opacity: 0.7;
        }

        /* Add animations */
        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add loading state styles */
        .contact-form button[type="submit"].loading {
            background: rgba(0, 255, 153, 0.3);
            pointer-events: none;
        }

        .contact-form button[type="submit"].loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: #000;
            border-radius: 50%;
            animation: buttonSpin 1s linear infinite;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        @keyframes buttonSpin {
            to {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        /* Required field indicator */
        .required::after {
            content: '*';
            color: var(--primary-color);
            margin-left: 4px;
        }

        /* Field validation styles */
        .contact-form input:invalid,
        .contact-form select:invalid {
            border-color: rgba(255, 68, 68, 0.5);
        }

        .contact-form input:invalid:focus,
        .contact-form select:invalid:focus {
            border-color: #FF4444;
            box-shadow: 0 0 0 4px rgba(255, 68, 68, 0.1);
        }

        /* Add more styles from frenchinterview.html as needed */
        @keyframes glow {
            from { box-shadow: 0px 0px 18px #00FF99; }
            to { box-shadow: 0px 0px 30px #00FF99; }
        }

        @keyframes borderGlow {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .hidden {
            display: none !important;
        }

        .error {
            position: relative;
            display: inline-block;
            background-color: rgba(255, 68, 68, 0.15) !important;
            border-bottom: 2px solid #FF4444 !important;
            color: inherit;
            cursor: help;
            transition: all 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 1px;
        }

        .error:hover {
            background-color: rgba(255, 68, 68, 0.25) !important;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
        }

        .error:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 125%;
            background: rgba(255, 68, 68, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: pre-wrap;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
            text-align: center;
            line-height: 1.4;
            pointer-events: none;
        }

        .feedback-message {
            background: rgba(0, 255, 153, 0.2);
            color: var(--primary-color);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            animation: fadeIn 0.3s ease-in;
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .topic-warning {
            color: #FF4444;
            font-weight: bold;
            text-shadow: 0px 0px 5px #FF4444;
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #FF4444;
            animation: fadeIn 0.3s ease-in;
        }

        .selected-topic-box {
            width: 90%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            padding: 15px;
            background: rgba(0, 255, 153, 0.2);
            border-radius: 15px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
        }

        .topic-label {
            font-size: 16px;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-weight: bold;
        }

        .topic-text {
            font-size: 20px;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 10px var(--primary-color);
        }

        .form-intro {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            padding: 15px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 255, 153, 0.3);
            min-height: 110px;
        }

        .ai-avatar-small {
            flex-shrink: 0;
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 10px;
            padding: 5px;
        }

        .ai-avatar-small::before {
            content: '✨';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            animation: sparkle 2s infinite;
            pointer-events: none;
            z-index: 1;
        }

        .ai-avatar-small::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-color) 0%, transparent 70%);
            animation: glowRing 3s infinite;
            pointer-events: none;
            z-index: 1;
        }

        .avatar-img-small {
            width: 100px;
            height: 100px;
            border-radius: 40px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
            object-fit: cover;
            position: relative;
            z-index: 2;
        }

        .intro-message {
            flex: 1;
            min-width: 0;
            padding-left: 5px;
        }

        .intro-message h2 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 24px;
            text-shadow: 0 0 10px var(--primary-color);
            animation: slideIn 0.5s ease-out;
        }

        .intro-message p {
            color: white;
            margin: 0;
            font-size: 16px;
            line-height: 1.4;
            opacity: 0.9;
            animation: fadeIn 0.8s ease-out;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .char-limit {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .char-limit-bar {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .char-limit-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .timer-container {
            width: 90%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: flex-end;
        }

        .timer {
            background: rgba(0, 255, 153, 0.1);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #timerDisplay {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            min-width: 100px;
        }

        .timer-controls {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
        }

        .timer.warning #timerDisplay {
            color: #FF4444;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .writing-stats {
            width: 90%;
            max-width: 800px;
            margin: 10px auto;
            display: flex;
            justify-content: space-around;
            color: var(--primary-color);
            font-size: 14px;
            background: rgba(0, 255, 153, 0.1);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--primary-color);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .icon {
            font-size: 16px;
        }

        /* Keyboard shortcuts tooltip */
        .shortcut-hint {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Add autosave indicator */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 255, 153, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .autosave-indicator.visible {
            opacity: 1;
        }

        /* Add these new animation keyframes after your existing keyframes */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 15px var(--primary-color); }
            50% { box-shadow: 0 0 25px var(--primary-color); }
            100% { box-shadow: 0 0 15px var(--primary-color); }
        }

        @keyframes rotate {
            0% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
            100% { transform: rotate(-5deg); }
        }

        /* Add animation to the features list */
        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .feature {
            padding: 8px;
            border-radius: 8px;
            background: rgba(0, 255, 153, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: none;
        }

        .feature:hover {
            transform: translateX(5px);
            background: rgba(0, 255, 153, 0.2);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .feature::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(0, 255, 153, 0.2),
                transparent
            );
            transition: 0.5s;
        }

        .feature:hover::before {
            left: 100%;
        }

        /* Add typing animation to the intro text */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        .intro-text h1 {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 2s steps(40, end);
            margin: 0 0 15px 0;
        }

        /* Add a wave animation to the emoji in the greeting */
        @keyframes wave {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-15deg); }
            60% { transform: rotate(15deg); }
            80% { transform: rotate(-15deg); }
            100% { transform: rotate(0deg); }
        }

        .intro-message h2 span {
            display: inline-block;
            animation: wave 2s infinite;
        }

        /* Add breathing effect to the main container */
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        /* Add dynamic border effect */
        .intro-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                var(--primary-color),
                transparent 60%,
                var(--primary-color)
            );
            border-radius: 16px;
            z-index: -1;
            animation: none;
        }

        @keyframes borderRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add typing cursor effect */
        .editor:empty::before {
            content: '|';
            animation: cursorBlink 1s infinite;
        }

        @keyframes cursorBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Add particle effects behind the avatar */
        .particle {
            position: absolute;
            pointer-events: none;
            background: var(--primary-color);
            border-radius: 50%;
            opacity: 0.3;
        }

        /* Add these new keyframes */
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        @keyframes glowRing {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.2; }
            100% { transform: scale(1); opacity: 0.5; }
        }

        /* Add pulsing effect to the features */
        @keyframes featurePulse {
            0% { transform: translateX(0); }
            50% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        /* Assessment Panel Styles */
        .assessment-panel {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 2px solid var(--primary-color);
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .level-badge {
            padding: 8px 15px;
            background: var(--primary-color);
            color: black;
            border-radius: 20px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .assessment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .assessment-category {
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid var(--primary-color);
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
        }

        .progress {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .score-label {
            position: absolute;
            right: 0;
            top: -20px;
            color: var(--primary-color);
        }

        .details-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            font-size: 14px;
        }

        .details-list li {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .details-list li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--primary-color);
        }

        .improvement-suggestions {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .vocabulary-analysis {
            margin: 20px 0;
        }

        .vocab-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
        }

        .vocab-level {
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .writing-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric {
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--primary-color);
        }

        .metric-label {
            font-size: 14px;
            color: var(--primary-color);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Add these new keyframes */
        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Add particle effects for the contact form */
        .form-intro {
            position: relative;
            overflow: hidden;
        }

        .form-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* Avatar and animation styles */
        .intro-container {
            background: rgba(0, 255, 153, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px auto;
            max-width: 800px;
            display: flex;
            align-items: center;
            gap: 30px;
            border: 1px solid var(--primary-color, #00FF99);
            box-shadow: 0 0 20px rgba(0, 255, 153, 0.2);
        }

        .ai-avatar {
            flex-shrink: 0;
            position: relative;
            cursor: pointer;
        }

        .avatar-img {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            border: 2px solid var(--primary-color, #00FF99);
            box-shadow: 0 0 15px var(--primary-color, #00FF99);
            object-fit: cover;
        }

        .intro-text {
            text-align: left;
        }

        .intro-text h1 {
            font-size: 32px;
            margin: 0;
            background: linear-gradient(45deg, var(--primary-color, #00FF99), #00ffcc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
        }

        .intro-text p {
            font-size: 18px;
            margin: 10px 0 20px;
            opacity: 0.9;
        }

        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .feature {
            font-size: 14px;
            padding: 8px 15px;
            background: rgba(0, 255, 153, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 153, 0.2);
        }

        @media (max-width: 768px) {
            .intro-container {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            .intro-text {
                text-align: center;
            }
            .features-list {
                grid-template-columns: 1fr;
            }
        }

        /* Animation styles */
        @keyframes super-funny-pulse {
            0% { transform: scale(1) rotate(0deg) translateY(0); filter: brightness(1.1) hue-rotate(0deg); }
            20% { transform: scale(1.15) rotate(-3deg) translateY(-2px); filter: brightness(1.4) hue-rotate(10deg); }
            40% { transform: scale(1.05) rotate(1deg) translateY(0); filter: brightness(1.2) hue-rotate(-5deg); }
            60% { transform: scale(1.12) rotate(3deg) translateY(-1px); filter: brightness(1.3) hue-rotate(-10deg); }
            80% { transform: scale(1.07) rotate(-2deg) translateY(0); filter: brightness(1.25) hue-rotate(5deg); }
            100% { transform: scale(1) rotate(0deg) translateY(0); filter: brightness(1.1) hue-rotate(0deg); }
        }

        .avatar-vibrating {
            animation: super-funny-pulse 1s ease-in-out infinite;
            border-radius: 60px;
            box-shadow: 0 0 25px var(--primary-color, #00FF99), 0 0 40px rgba(0, 255, 153, 0.5);
            transition: all 0.3s ease;
        }

        .avatar-vibrating::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 70px;
            background: linear-gradient(45deg, #00ff99, #00ffcc, #00ccff, #ff00cc, #ffcc00, #00ff99);
            background-size: 300% 300%;
            z-index: -1;
            animation: gradient-shift 3s ease infinite;
            opacity: 0.8;
            filter: blur(3px);
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .sparkle {
            position: absolute;
            background: white;
            border-radius: 50%;
            filter: blur(1px);
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            animation: sparkle-fade 1.5s ease-in-out forwards;
        }

        @keyframes sparkle-fade {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1) rotate(180deg); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        @keyframes cute-bounce {
            0%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-15px); }
            80% { transform: translateY(-5px); }
        }

        .ai-avatar:hover .avatar-img {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 30px var(--primary-color, #00FF99), 0 0 50px rgba(0, 255, 153, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popBubble {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            40% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            60% { transform: scale(1.1) rotate(-5deg); opacity: 1; }
            100% { transform: scale(1.3) translateY(-25px); opacity: 0; }
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0.7; }
            25% { transform: translate(15px, -15px) rotate(5deg); opacity: 0.9; }
            50% { transform: translate(25px, -5px) rotate(0deg); opacity: 0.7; }
            75% { transform: translate(10px, 10px) rotate(-5deg); opacity: 0.9; }
            100% { transform: translate(0, 0) rotate(0deg); opacity: 0.7; }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); filter: brightness(1.3); }
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }

        #name, #email, #phone, #message, #french, #english, .form-input, input[type="text"] {
          height: 80px;
          width: 80%; /* Reduce this value */
          padding: 15px; /* You may also want to reduce padding */
        }

        /* Grammar checker styles */
        .error {
            position: relative;
            display: inline-block;
            background-color: rgba(255, 68, 68, 0.15) !important;
            border-bottom: 2px solid #FF4444 !important;
            color: inherit;
            cursor: help;
            transition: all 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 1px;
        }

        .error:hover {
            background-color: rgba(255, 68, 68, 0.25) !important;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
        }

        .error:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 125%;
            background: rgba(255, 68, 68, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: pre-wrap;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
            text-align: center;
            line-height: 1.4;
            pointer-events: none;
        }

        #textEditor {
            position: relative;
            width: 90%;
            max-width: 800px;
            min-height: 200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            line-height: 1.5;
            outline: none;
            transition: all 0.3s ease;
        }

        #textEditor:focus {
            box-shadow: 0 0 15px var(--primary-color);
            background: rgba(0, 0, 0, 0.5);
        }

        #floating-tooltip {
            position: fixed;
            background: rgba(255, 68, 68, 0.95);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            line-height: 1.4;
            pointer-events: none;
            display: none;
        }

        .feedback-message {
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0, 255, 153, 0.1);
            border: 1px solid var(--primary-color);
            max-width: 800px;
            text-align: left;
        }

        .error-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            border-left: 3px solid #FF4444;
        }

        .error-item div {
            margin: 5px 0;
        }

        /* Loading spinner */
        .fa-spinner {
            margin-right: 10px;
            color: var(--primary-color);
        }

        /* Success message */
        .feedback-message[style*="border-color: #00FFB3"] {
            background: rgba(0, 255, 179, 0.1);
        }

        /* Error message */
        .feedback-message[style*="border-color: #FF4444"] {
            background: rgba(255, 68, 68, 0.1);
        }

        .corrected-text-box {
            position: relative;
            width: 90%;
            max-width: 800px;
            min-height: 200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 255, 153, 0.1);
            border: 2px solid #00FFB3;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .correction {
            background-color: rgba(0, 255, 153, 0.2);
            color: #00FFB3;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 1px;
            transition: all 0.3s ease;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: black;
            font-weight: bold;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary-color);
        }
        
        #correction-area {
            margin: 30px auto;
            padding: 20px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #00FFB3;
            max-width: 850px;
            animation: fadeIn 0.5s ease-in;
        }
        
        .section-title {
            text-align: center;
            color: #00FFB3;
            margin-bottom: 15px;
            font-size: 20px;
            text-shadow: 0 0 10px #00FFB3;
        }
    </style>
</head>
<body>
    <!-- Hemiya AI Introduction -->
    <div class="intro-container">
        <div class="ai-avatar">
            <img src="https://yiyang512.github.io/new/hemiya.jpg" alt="Hemiya AI" class="avatar-img">
        </div>
        <div class="intro-text">
            <h1>Meet Hemiya - Your AI French Coach 👋</h1>
            <p>Practice your French writing with real-time feedback</p>
            <div class="features-list">
                <div class="feature">⦿ Smart Level Assessment (A1-B2)</div>
                <div class="feature">⦿ Real-time Grammar Corrections</div>
                <div class="feature">⦿ Vocabulary Suggestions</div>
                <div class="feature">⦿ Writing Structure Guidance</div>
                <div class="feature">⦿ Personalized Feedback</div>
                <div class="feature">⦿ 100% Private - No Data Stored</div>
            </div>
        </div>
    </div>

    <!-- Add the audio element right after the intro-container -->
    <audio id="introAudio" preload="auto" style="display: none;">
        <source src="https://yiyang512.github.io/new/hemiya.mp3" type="audio/mpeg">
    </audio>

    <!-- Step Indicators -->
    <div class="step-indicator">
        <div class="step active" id="step1">Step 1: Choose Level & Topic</div>
        <div class="step" id="step2">Step 2: Write Your Response</div>
    </div>

    <!-- Step 1: Topic Selection -->
    <div id="topicSelection">
        <select id="levelSelect">
            <option value="">Select Level (A1 - C2)</option>
            <option value="A1">A1 - Beginner</option>
            <option value="A2">A2 - Elementary</option>
            <option value="B1">B1 - Intermediate</option>
            <option value="B2">B2 - Upper Intermediate</option>
            <option value="C1">C1 - Advanced</option>
            <option value="C2">C2 - Proficient</option>
        </select>
        <button class="btn-green" onclick="generateTopic()">Generate Topic</button>
        <button class="btn-red" onclick="randomizeTopic()">Randomize Topic</button>
        <div class="topic-box" id="writingTopic">Click "Generate Topic" or "Randomize Topic"</div>
        <button class="btn-green" onclick="proceedToWriting()">Continue to Writing ➡️</button>
    </div>

    <!-- Step 2: Writing Board -->
    <div id="writingBoard" class="hidden">
        <div class="selected-topic-box">
            <div class="topic-label">Your Topic:</div>
            <div id="selectedTopic" class="topic-text"></div>
            <!-- Add Select Another Topic button -->
            <button class="btn-blue" onclick="goBackToTopicSelection()">Select Another Topic</button>
        </div>
        <div class="timer-container">
            <div class="timer" id="timer">
                <span id="timerDisplay">30:00</span>
                <div class="timer-controls">
                    <button class="btn-small" onclick="startTimer()">Start</button>
                    <button class="btn-small" onclick="pauseTimer()">Pause</button>
                    <button class="btn-small" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        </div>
        <div class="editor" contenteditable="true" id="textEditor">
            Type your response in French here...
        </div>
        <div class="char-limit">
            <div class="char-limit-bar">
                <div class="char-limit-fill" id="charLimitFill"></div>
            </div>
            <span id="charLimitText">0/500</span>
        </div>
        <div class="controls">
            <button class="btn-red" onclick="clearText()">Clear</button>
            <button class="btn-green" onclick="checkGrammar()">Check Grammar</button>
        </div>
        <div id="grammar-errors"></div>
        <div class="writing-stats">
            <div class="stat">
                <span class="icon">📝</span>
                <span id="wordCount">0</span> words
            </div>
            <div class="stat">
                <span class="icon">⌨️</span>
                <span id="charCount">0</span> characters
            </div>
            <div class="stat">
                <span class="icon">⏱️</span>
                Est. reading time: <span id="readingTime">0</span> min
            </div>
        </div>
        <div class="assessment-panel hidden" id="assessmentPanel">
            <div class="assessment-header">
                <h3>📊 Comprehensive Writing Assessment</h3>
                <div class="level-badge" id="assessedLevel">A2</div>
            </div>
            
            <div class="assessment-grid">
                <div class="assessment-category">
                    <h4>Grammar & Structure</h4>
                    <div class="progress-bar">
                        <div class="progress" id="grammarScore"></div>
                        <span class="score-label">85%</span>
                    </div>
                    <ul class="details-list" id="grammarDetails"></ul>
                </div>
                
                <div class="assessment-category">
                    <h4>Vocabulary Usage</h4>
                    <div class="progress-bar">
                        <div class="progress" id="vocabScore"></div>
                        <span class="score-label">78%</span>
                    </div>
                    <ul class="details-list" id="vocabDetails"></ul>
                </div>
                
                <div class="assessment-category">
                    <h4>Style & Coherence</h4>
                    <div class="progress-bar">
                        <div class="progress" id="styleScore"></div>
                        <span class="score-label">90%</span>
                    </div>
                    <ul class="details-list" id="styleDetails"></ul>
                </div>
            </div>

            <div class="improvement-suggestions">
                <h4>🎯 Areas for Improvement</h4>
                <ul id="improvementList"></ul>
            </div>

            <div class="vocabulary-analysis">
                <h4>📚 Vocabulary Analysis</h4>
                <div class="vocab-chart" id="vocabChart">
                    <div class="vocab-level">Advanced Words: <span id="advancedCount">12</span></div>
                    <div class="vocab-level">Intermediate Words: <span id="intermediateCount">25</span></div>
                    <div class="vocab-level">Basic Words: <span id="basicCount">45</span></div>
                </div>
            </div>

            <div class="writing-metrics">
                <div class="metric">
                    <span class="metric-label">Sentence Length Variation</span>
                    <div class="metric-value" id="sentenceLengthVar"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Text Coherence</span>
                    <div class="metric-value" id="textCoherence"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Expression Diversity</span>
                    <div class="metric-value" id="expressionDiversity"></div>
                </div>
            </div>

            <button class="btn-green" onclick="generateDetailedReport()">
                📋 Generate Detailed Report
            </button>
        </div>
        <!-- Add this HTML section after the grammar-errors div in the writingBoard section -->
        <div id="correction-area" class="hidden">
            <h3 class="section-title">Corrected Version</h3>
            <div id="corrected-text" class="corrected-text-box"></div>
            <div class="button-container">
                <button id="apply-corrections" class="btn-primary">Apply All Corrections</button>
                <button id="copy-corrections" class="btn-secondary">Copy Corrected Text</button>
                <button id="dismiss-corrections" class="btn-secondary">Dismiss</button>
            </div>
        </div>
    </div>

    <!-- Contact Form Overlay -->
    <div id="contactOverlay" class="overlay hidden">
        <div class="contact-form">
            <div class="form-intro">
                <div class="ai-avatar-small">
                    <img src="https://yiyang512.github.io/new/hemiya.jpg" alt="Hemiya AI" class="avatar-img-small">
                </div>
                <div class="intro-message">
                    <h2><span>👋</span> Welcome to Hemiya AI</h2>
                    <p>Let's personalize your French learning experience. Please provide a few details to get started.</p>
                </div>
            </div>
            <form id="contactForm">
                <div class="form-group">
                    <label class="required" for="name">Full Name</label>
                    <input 
                        type="text" 
                        id="name" 
                        placeholder="Enter your name" 
                        required 
                        minlength="2"
                    >
                </div>
                
                <div class="form-group">
                    <label class="required" for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        placeholder="your.email@example.com" 
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input 
                        type="tel" 
                        id="phone" 
                        placeholder="Optional"
                        pattern="[0-9+\-\s]+"
                    >
                </div>
                
                <div class="form-group">
                    <label class="required" for="targetLevel">Target French Level</label>
                    <select id="targetLevel" required>
                        <option value="">Select your target level</option>
                        <option value="A1">A1 - Beginner</option>
                        <option value="A2">A2 - Elementary</option>
                        <option value="B1">B1 - Intermediate</option>
                        <option value="B2">B2 - Upper Intermediate</option>
                        <option value="C1">C1 - Advanced</option>
                        <option value="C2">C2 - Proficient</option>
                    </select>
                </div>

                <button type="submit" id="submitBtn">
                    Start Your French Journey
                </button>
            </form>
        </div>
    </div>

    <!-- Add this audio element at the end of body -->
    <audio id="timerBeep" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- Add this near the end of the body -->
    <div class="autosave-indicator">
        <span class="icon">💾</span> Auto-saving...
    </div>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("_KKm93NyfWfCIx2nC");
        })();

        // Topics data
        const topics = {
            A1: [
                { en: "Introduce yourself in French.", fr: "Présentez-vous en français." },
                { en: "Describe your daily routine.", fr: "Décrivez votre routine quotidienne." },
                { en: "Write an invitation letter.", fr: "Écrivez une lettre d'invitation." },
                { en: "Talk about your family.", fr: "Parlez de votre famille." },
                { en: "Write about your favorite food.", fr: "Écrivez sur votre nourriture préférée." }
            ],
            A2: [
                { en: "Write about your last vacation.", fr: "Écrivez sur vos dernières vacances." },
                { en: "Describe your dream house.", fr: "Décrivez la maison de vos rêves." },
                { en: "Book a hotel room in French.", fr: "Réservez une chambre d'hôtel en français." },
                { en: "Talk about your hobbies.", fr: "Parlez de vos loisirs." },
                { en: "Write about your neighborhood.", fr: "Écrivez sur votre quartier." }
            ],
            B1: [
                { en: "Pros and cons of living in a big city.", fr: "Les avantages et inconvénients de vivre dans une grande ville." },
                { en: "Describe a moment when you helped someone.", fr: "Décrivez un moment où vous avez aidé quelqu'un." },
                { en: "Importance of learning French.", fr: "L'importance d'apprendre le français." },
                { en: "Describe your ideal job.", fr: "Décrivez votre emploi idéal." },
                { en: "Write about a cultural experience.", fr: "Écrivez sur une expérience culturelle." }
            ],
            B2: [
                { en: "Impact of social media on relationships.", fr: "L'impact des réseaux sociaux sur les relations." },
                { en: "Write a job application letter.", fr: "Rédigez une lettre de candidature." },
                { en: "Technology makes life better - Agree or disagree?", fr: "La technologie améliore la vie - Êtes-vous d'accord ou non ?" },
                { en: "Describe a challenge you've overcome.", fr: "Décrivez un défi que vous avez surmonté." },
                { en: "Compare education systems in different countries.", fr: "Comparez les systèmes éducatifs de différents pays." }
            ],
            C1: [
                { en: "Effects of climate change on the economy.", fr: "Les effets du changement climatique sur l'économie." },
                { en: "Why should students learn multiple languages?", fr: "Pourquoi les étudiants devraient-ils apprendre plusieurs langues ?" },
                { en: "Ethical implications of AI.", fr: "Les implications éthiques de l'intelligence artificielle." },
                { en: "Analyze the role of media in modern society.", fr: "Analysez le rôle des médias dans la société moderne." },
                { en: "Discuss work-life balance in the digital age.", fr: "Discutez de l'équilibre travail-vie dans l'ère numérique." }
            ],
            C2: [
                { en: "Globalization and language diversity.", fr: "La mondialisation et la diversité linguistique." },
                { en: "The role of literature in society.", fr: "Le rôle de la littérature dans la société." },
                { en: "The advantages and disadvantages of free speech.", fr: "Les avantages et inconvénients de la liberté d'expression." },
                { en: "Analyze philosophical perspectives on happiness.", fr: "Analysez les perspectives philosophiques sur le bonheur." },
                { en: "Critique modern art movements.", fr: "Critiquez les mouvements artistiques modernes." }
            ]
        };

        // Show contact form on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('contactOverlay').classList.remove('hidden');
        });

        // Handle contact form submission
        document.getElementById('contactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.classList.add('loading');
            submitBtn.textContent = 'Processing...';
            
            // Collect form data
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                targetLevel: document.getElementById('targetLevel').value
            };

            // Send email notification
            emailjs.send("service_fr7pas9", "template_qk5xq0o", {
                name: formData.name,
                time: new Date().toISOString(),
                message: `
                    Email: ${formData.email}
                    Current Level: ${formData.targetLevel}
                    Phone: ${formData.phone || 'Not provided'}
                    Registration Time: ${new Date().toISOString()}
                    Browser: ${navigator.userAgent}
                    Screen Size: ${window.innerWidth}x${window.innerHeight}
                `
            })
            .then(function() {
                // Hide the overlay immediately
                document.getElementById('contactOverlay').style.display = 'none';
                
                // Show success notification
                showNotification(`Welcome ${formData.name}! You can now start your practice.`, 'success');
                
                // Store contact info in localStorage
                localStorage.setItem('userContact', JSON.stringify(formData));
                
                // Remove loading state
                submitBtn.classList.remove('loading');
                submitBtn.textContent = 'Start Your French Journey';
                
                // PLAY AUDIO AFTER SUCCESSFUL FORM SUBMISSION - with a slight delay to ensure smooth transition
                setTimeout(() => {
                    playAudioWithAnimation();
                }, 800);
            })
            .catch(function(error) {
                console.error('EmailJS error:', error);
                
                // Still hide the overlay
                document.getElementById('contactOverlay').classList.add('hidden');
                
                // Show error notification
                showNotification('Welcome! You can start your practice now.', 'error');
                
                // Remove loading state
                submitBtn.classList.remove('loading');
                submitBtn.textContent = 'Start Your French Journey';
                
                // Also try to play audio even if email fails
                setTimeout(() => {
                    playAudioWithAnimation();
                }, 800);
            });
        });

        // Remove any other form submission handlers that might be trying to play audio

        // Add this helper function to centralize audio playback logic
        function playAudioWithAnimation() {
            console.log("Attempting to play audio after form submission");
            const introAudio = document.getElementById('introAudio');
            const avatarImg = document.querySelector('.avatar-img');
            
            // Force audio to load
            introAudio.load();
            
            // Try to play with proper error handling
            const playPromise = introAudio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    // Audio playback started successfully
                    console.log("✅ Audio started playing after form submission");
                    startPulsingWithIntervals(avatarImg);
                }).catch(error => {
                    // Auto-play was prevented
                    console.error("❌ Audio play failed:", error);
                    
                    // Still show animation even if audio fails
                    startPulsingWithIntervals(avatarImg);
                    
                    // Show notification to guide the user
                    showNotification("Click on Hemiya's avatar to hear the welcome message!", "info");
                });
            }
        }

        // Topic generation functions
        function generateTopic() {
            const level = document.getElementById('levelSelect').value;
            const warningDiv = document.getElementById('topic-warning') || document.createElement('div');
            warningDiv.id = 'topic-warning';
            warningDiv.className = 'topic-warning';
            
            if (!level) {
                warningDiv.innerText = "⚠️ Please select a level first!";
                const topicBox = document.getElementById('writingTopic');
                topicBox.parentNode.insertBefore(warningDiv, topicBox);
                return;
            }

            // Remove warning if it exists
            if (warningDiv.parentNode) {
                warningDiv.remove();
            }

            const topic = topics[level][Math.floor(Math.random() * topics[level].length)];
            document.getElementById('writingTopic').innerHTML = `
                <div style="font-size: 18px; margin-bottom: 10px; color: var(--primary-color); font-weight: bold;">(${level})</div>
                <div style="font-size: 16px; margin-bottom: 8px; color: white;">${topic.en}</div>
                <div style="font-size: 16px; color: #00FFCC; font-style: italic;">${topic.fr}</div>
            `;
        }

        function randomizeTopic() {
            const levels = Object.keys(topics);
            const randomLevel = levels[Math.floor(Math.random() * levels.length)];
            const topic = topics[randomLevel][Math.floor(Math.random() * topics[randomLevel].length)];
            document.getElementById('writingTopic').innerHTML = `
                <div style="font-size: 18px; margin-bottom: 10px; color: var(--primary-color); font-weight: bold;">(${randomLevel})</div>
                <div style="font-size: 16px; margin-bottom: 8px; color: white;">${topic.en}</div>
                <div style="font-size: 16px; color: #00FFCC; font-style: italic;">${topic.fr}</div>
            `;
        }

        // Navigation between steps
        function proceedToWriting() {
            const topicBox = document.getElementById('writingTopic');
            const topicContent = topicBox.innerHTML;
            const warningDiv = document.getElementById('topic-warning') || document.createElement('div');
            warningDiv.id = 'topic-warning';
            warningDiv.className = 'topic-warning';
            
            if (topicContent === 'Click "Generate Topic" or "Randomize Topic"') {
                warningDiv.innerText = "⚠️ Please generate a topic first!";
                topicBox.parentNode.insertBefore(warningDiv, topicBox);
                return;
            }

            // Remove warning if it exists
            if (warningDiv.parentNode) {
                warningDiv.remove();
            }
            
            // Copy the topic to the writing board (keeping both languages)
            document.getElementById('selectedTopic').innerHTML = topicContent;
            
            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('writingBoard').classList.remove('hidden');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            
            // Add this line to start timer automatically
            startTimer();

            // Load any saved draft
            const savedDraft = localStorage.getItem('writingDraft');
            if (savedDraft) {
                const draft = JSON.parse(savedDraft);
                if (draft.topic === topicContent) {
                    document.getElementById('textEditor').innerText = draft.text;
                    updateWritingStats();
                }
            }
        }

        // Writing board functions
        function clearText() {
            document.getElementById('textEditor').innerHTML = '';
        }

        // Add this at the start of your script section
        const textEditor = document.getElementById('textEditor');

        // Clear placeholder text on focus
        textEditor.addEventListener('focus', function() {
            if (this.innerText === 'Type your response in French here...') {
                this.innerText = '';
            }
        });

        // Restore placeholder if empty on blur
        textEditor.addEventListener('blur', function() {
            if (this.innerText.trim() === '') {
                this.innerText = 'Type your response in French here...';
            }
        });

        async function checkGrammar() {
            let editor = document.getElementById('textEditor');
            let text = editor.innerText || editor.textContent;
            let grammarErrors = document.getElementById('grammar-errors');
            let correctionArea = document.getElementById('correction-area');
            let correctedTextBox = document.getElementById('corrected-text');

            // Clear any existing error highlights
            editor.innerHTML = text;
            correctionArea.classList.add('hidden');
            
            // Clear any existing correction summary
            const existingSummary = document.querySelector('#correction-area .correction-summary');
            if (existingSummary) {
                existingSummary.remove();
            }

            if (text.trim() === '' || text === 'Type your response in French here...') {
                grammarErrors.innerHTML = `
                    <div class="feedback-message" style="border-color: #FF4444; box-shadow: 0 0 10px #FF4444;">
                        Please write something before checking grammar.
                    </div>`;
                return;
            }

            try {
                // Show checking message with comprehensive correction notice
                grammarErrors.innerHTML = `
                    <div class="feedback-message">
                        <i class="fas fa-spinner fa-spin"></i> Performing comprehensive grammar analysis...
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                            ✍️ Deep correction: Grammar • Structure • Verb tenses • Articles • Natural expressions
                        </div>
                    </div>`;

                // Enhanced LanguageTool API call with comprehensive rules
                const response = await fetch('https://api.languagetool.org/v2/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'text': text,
                        'language': 'fr',
                        'enabledOnly': 'false',
                        'enabledCategories': 'GRAMMAR,TYPOS,PUNCTUATION,CASING,CONFUSED_WORDS,REDUNDANCY,STYLE,SEMANTICS',
                        'level': 'picky' // Enable more comprehensive checking
                    })
                });

                const data = await response.json();
                console.log('LanguageTool response:', data);

                if (!data.matches || data.matches.length === 0) {
                    grammarErrors.innerHTML = `
                        <div class="feedback-message" style="border-color: #00FFB3; box-shadow: 0 0 10px #00FFB3;">
                            🎉 Comprehensive analysis complete - No grammar mistakes found! 
                            <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                                ✅ Grammar • Structure • Verb tenses • Articles • Natural flow
                            </div>
                        </div>`;
                    return;
                }

                // Apply comprehensive correction principles
                let correctedText = await applyComprehensiveCorrections(text, data.matches);
                
                // Enhanced error processing for display
                let tempDiv = document.createElement('div');
                tempDiv.textContent = text;
                let html = tempDiv.innerHTML;
                let offset = 0;
                let errorSummary = '';

                // Categorize errors by type for better organization
                const errorCategories = categorizeErrors(data.matches);
                
                // Sort matches by offset in reverse order for HTML highlighting
                data.matches.sort((a, b) => b.offset - a.offset);

                data.matches.forEach((match, index) => {
                    const start = match.offset + offset;
                    const end = start + match.length;
                    const errorText = text.substring(match.offset, match.offset + match.length);
                    
                    // Enhanced tooltip with correction type
                    const correctionType = getCorrectionType(match);
                    const replacement = `<span class="error" 
                        data-error-id="${index}"
                        data-tooltip="${correctionType}: ${match.message}${match.replacements.length > 0 ? '\n✅ Correction: ' + match.replacements[0].value : ''}"
                        style="background-color: rgba(255, 68, 68, 0.15); border-bottom: 2px solid #FF4444;"
                        >${errorText}</span>`;

                    html = html.substring(0, start) + replacement + html.substring(end);
                    offset += replacement.length - match.length;

                    // Enhanced error summary with categories
                    errorSummary = `
                        <div class="error-item">
                            <div style="color: #FF4444; font-weight: bold;">${correctionType} Error ${data.matches.length - index}:</div>
                            <div style="color: white;">"${errorText}" - ${match.message}</div>
                            ${match.replacements.length > 0 ? 
                                `<div style="color: #00FFB3;">✅ Professional correction: "${match.replacements[0].value}"</div>` : 
                                ''}
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.8em;">Category: ${correctionType}</div>
                        </div>
                    ` + errorSummary;
                });

                // Update editor with highlighted errors
                editor.innerHTML = html;

                // Enhanced error summary with professional analysis
                grammarErrors.innerHTML = `
                    <div class="feedback-message" style="border-color: #FF4444; box-shadow: 0 0 10px #FF4444;">
                        <div style="font-size: 1.1em; margin-bottom: 15px;">
                            📝 Professional Grammar Analysis: Found ${data.matches.length} ${data.matches.length === 1 ? 'issue' : 'issues'}
                        </div>
                        <div style="font-size: 0.9em; margin-bottom: 15px; padding: 10px; background: rgba(0,255,153,0.1); border-radius: 5px;">
                            <strong>🎯 Correction Focus:</strong><br>
                            ${Object.entries(errorCategories).map(([category, count]) => 
                                `• ${category}: ${count} ${count === 1 ? 'issue' : 'issues'}`
                            ).join('<br>')}
                        </div>
                        ${errorSummary}
                        <div style="margin-top: 15px; font-size: 0.9em; color: rgba(255, 255, 255, 0.7);">
                            💡 Hover over highlighted text for detailed professional corrections.
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button id="show-corrected" class="btn btn-primary">Show Professionally Corrected Version</button>
                        </div>
                    </div>
                `;

                // Set the comprehensively corrected text
                correctedTextBox.textContent = correctedText;
                
                // Enhanced correction summary
                const corrections = await getDetailedCorrections(text, data.matches);
                const correctionSummary = document.createElement('div');
                correctionSummary.className = 'correction-summary';
                correctionSummary.style.cssText = `
                    margin-top: 15px;
                    padding: 15px;
                    background: rgba(0, 255, 153, 0.1);
                    border-radius: 8px;
                    border: 1px solid var(--primary-color);
                    font-size: 14px;
                    color: var(--primary-color);
                `;
                correctionSummary.innerHTML = `
                    <strong>✅ Professional Corrections Applied (${corrections.length}):</strong>
                    <div style="margin-top: 10px;">
                        ${corrections.map((corr, idx) => 
                            `<div style="margin: 8px 0; padding: 8px; background: rgba(0,255,153,0.05); border-radius: 4px;">
                                <strong>${idx + 1}. ${corr.type}:</strong><br>
                                <span style="color: #FF6B6B;">"${corr.original}"</span> → 
                                <span style="color: #4ECDC4;">"${corr.replacement}"</span>
                                <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">${corr.explanation}</div>
                            </div>`
                        ).join('')}
                    </div>
                `;

                // Add event listeners and correction functionality
                setupCorrectionHandlers(correctedText, correctionSummary);

            } catch (error) {
                console.error('Grammar check error:', error);
                grammarErrors.innerHTML = `
                    <div class="feedback-message" style="border-color: #FF4444; box-shadow: 0 0 10px #FF4444;">
                        Error during comprehensive analysis. Please try again.
                    </div>`;
            }

            // Run comprehensive assessment
            setTimeout(async () => {
                await assessWriting();
            }, 500);
        }

        // Helper function to apply comprehensive corrections
        async function applyComprehensiveCorrections(text, matches) {
            let correctedText = text;
            
            // STEP 1: Apply STRICT GRAMMAR MODE first - fix malformed sentence starters
            correctedText = applyStrictGrammarMode(correctedText);
            
            // STEP 2: Apply LanguageTool suggestions
            const corrections = matches
                .filter(match => match.replacements && match.replacements.length > 0)
                .map(match => ({
                    offset: match.offset,
                    length: match.length,
                    original: text.substring(match.offset, match.offset + match.length),
                    replacement: match.replacements[0].value,
                    type: getCorrectionType(match)
                }))
                .sort((a, b) => b.offset - a.offset);
            
            // Apply all LanguageTool corrections
            corrections.forEach(correction => {
                correctedText = correctedText.substring(0, correction.offset) + 
                               correction.replacement + 
                               correctedText.substring(correction.offset + correction.length);
                console.log(`✅ ${correction.type}: "${correction.original}" → "${correction.replacement}"`);
            });

            return correctedText;
        }

        // 🔧 STRICT GRAMMAR MODE: Handle malformed sentence starters and redundant words
        function applyStrictGrammarMode(text) {
            let correctedText = text;
            
            // Split into sentences for individual processing
            const sentences = correctedText.split(/([.!?]+\s*)/);
            
            for (let i = 0; i < sentences.length; i += 2) { // Process only sentence content, not punctuation
                if (sentences[i] && sentences[i].trim()) {
                    sentences[i] = fixMalformedSentenceStart(sentences[i]);
                }
            }
            
            correctedText = sentences.join('');
            console.log('🔧 Strict Grammar Mode applied');
            
            return correctedText;
        }

        // Fix malformed sentence beginnings and redundant words
        function fixMalformedSentenceStart(sentence) {
            let fixed = sentence.trim();
            
            // Common French malformed patterns - prioritize grammatical accuracy
            const strictPatterns = [
                // ❌ "Il a y avait" → ✅ "Il y avait"
                { pattern: /^(\s*)Il\s+a\s+y\s+avait/i, replacement: '$1Il y avait' },
                
                // ❌ "Elle a y a" → ✅ "Il y a" 
                { pattern: /^(\s*)Elle\s+a\s+y\s+a/i, replacement: '$1Il y a' },
                
                // ❌ "Il a il y avait" → ✅ "Il y avait" (delete redundant subject/verb)
                { pattern: /^(\s*)Il\s+a\s+il\s+y\s+avait/i, replacement: '$1Il y avait' },
                
                // ❌ "Je suis je vais" → ✅ "Je vais" (delete redundant subject/verb)
                { pattern: /^(\s*)Je\s+suis\s+je\s+(vais|peux|dois|veux)/i, replacement: '$1Je $2' },
                
                // ❌ "Tu as tu es" → ✅ "Tu es" (delete redundant subject/verb)
                { pattern: /^(\s*)Tu\s+as\s+tu\s+es/i, replacement: '$1Tu es' },
                { pattern: /^(\s*)Tu\s+es\s+tu\s+(vas|peux|dois|veux)/i, replacement: '$1Tu $2' },
                
                // ❌ "Il est il va" → ✅ "Il va" (delete redundant subject/verb)
                { pattern: /^(\s*)Il\s+est\s+il\s+(va|peut|doit|veut)/i, replacement: '$1Il $2' },
                { pattern: /^(\s*)Elle\s+est\s+elle\s+(va|peut|doit|veut)/i, replacement: '$1Elle $2' },
                
                // ❌ "Nous sommes nous allons" → ✅ "Nous allons"
                { pattern: /^(\s*)Nous\s+sommes\s+nous\s+(allons|pouvons|devons|voulons)/i, replacement: '$1Nous $2' },
                
                // ❌ "Vous êtes vous allez" → ✅ "Vous allez"
                { pattern: /^(\s*)Vous\s+êtes\s+vous\s+(allez|pouvez|devez|voulez)/i, replacement: '$1Vous $2' },
                
                // ❌ "Ils sont ils vont" → ✅ "Ils vont"
                { pattern: /^(\s*)Ils\s+sont\s+ils\s+(vont|peuvent|doivent|veulent)/i, replacement: '$1Ils $2' },
                { pattern: /^(\s*)Elles\s+sont\s+elles\s+(vont|peuvent|doivent|veulent)/i, replacement: '$1Elles $2' },
                
                // ❌ "C'est c'est" → ✅ "C'est" (delete duplicate phrases)
                { pattern: /^(\s*)C'est\s+c'est/i, replacement: '$1C\'est' },
                
                // ❌ "Il y a il y a" → ✅ "Il y a"
                { pattern: /^(\s*)Il\s+y\s+a\s+il\s+y\s+a/i, replacement: '$1Il y a' },
                
                // ❌ "Je pense je crois" → ✅ "Je pense" (conflicting verbs, keep first)
                { pattern: /^(\s*)Je\s+(pense|crois|suppose)\s+je\s+(pense|crois|suppose)/i, replacement: '$1Je $2' },
                
                // ❌ Double auxiliaries: "J'ai j'ai mangé" → ✅ "J'ai mangé"
                { pattern: /^(\s*)J'ai\s+j'ai\s+/i, replacement: '$1J\'ai ' },
                { pattern: /^(\s*)Tu\s+as\s+tu\s+as\s+/i, replacement: '$1Tu as ' },
                { pattern: /^(\s*)Il\s+a\s+il\s+a\s+/i, replacement: '$1Il a ' },
                { pattern: /^(\s*)Elle\s+a\s+elle\s+a\s+/i, replacement: '$1Elle a ' },
                
                // ❌ "Je vais je" → ✅ "Je vais" (incomplete repetition)
                { pattern: /^(\s*)Je\s+(vais|peux|dois|veux)\s+je\s*$/i, replacement: '$1Je $2' },
                
                // ❌ Starting with articles before correction: "Le il y a" → ✅ "Il y a"
                { pattern: /^(\s*)(Le|La|Les)\s+(il|elle)\s+/i, replacement: '$1$3 ' },
                
                // ❌ Malformed "qu'il y a": "que il y a" → ✅ "qu'il y a"
                { pattern: /^(\s*)que\s+il\s+y\s+a/i, replacement: '$1qu\'il y a' },
                
                // ❌ Wrong negative: "Je ne pas" → ✅ "Je ne" (let other corrections handle the rest)
                { pattern: /^(\s*)Je\s+ne\s+pas\s+(?!ne)/i, replacement: '$1Je ne ' }
            ];
            
            // Apply strict grammar patterns
            let originalFixed = fixed;
            strictPatterns.forEach(({pattern, replacement}) => {
                if (pattern.test(fixed)) {
                    const beforeFix = fixed;
                    fixed = fixed.replace(pattern, replacement);
                    if (beforeFix !== fixed) {
                        console.log(`🔧 STRICT: "${beforeFix.trim()}" → "${fixed.trim()}"`);
                    }
                }
            });
            
            // Additional cleanup: remove extra spaces
            fixed = fixed.replace(/\s+/g, ' ').trim();
            
            return fixed;
        }

        // Helper function to categorize errors
        function categorizeErrors(matches) {
            const categories = {};
            matches.forEach(match => {
                const type = getCorrectionType(match);
                categories[type] = (categories[type] || 0) + 1;
            });
            return categories;
        }

        // Helper function to get correction type
        function getCorrectionType(match) {
            const category = match.rule?.category?.id || '';
            const ruleId = match.rule?.id || '';
            
            if (category.includes('GRAMMAR') || ruleId.includes('AGREEMENT')) return 'Grammar & Agreement';
            if (category.includes('TYPOS') || ruleId.includes('SPELLING')) return 'Spelling';
            if (category.includes('PUNCTUATION')) return 'Punctuation';
            if (ruleId.includes('VERB') || ruleId.includes('TENSE')) return 'Verb Tense';
            if (ruleId.includes('ARTICLE') || ruleId.includes('DET')) return 'Articles';
            if (category.includes('STYLE') || ruleId.includes('STYLE')) return 'Style & Flow';
            if (category.includes('CONFUSED_WORDS')) return 'Word Choice';
            if (category.includes('REDUNDANCY')) return 'Redundancy';
            return 'General';
        }

        // Helper function to get detailed corrections
        async function getDetailedCorrections(text, matches) {
            return matches
                .filter(match => match.replacements && match.replacements.length > 0)
                .map(match => ({
                    original: text.substring(match.offset, match.offset + match.length),
                    replacement: match.replacements[0].value,
                    type: getCorrectionType(match),
                    explanation: match.message
                }));
        }

        // Helper function to setup correction handlers
        function setupCorrectionHandlers(correctedText, correctionSummary) {
            // Show corrected version handler
            document.getElementById('show-corrected').addEventListener('click', function() {
                const correctionArea = document.getElementById('correction-area');
                const buttonContainer = correctionArea.querySelector('.button-container');
                correctionArea.insertBefore(correctionSummary, buttonContainer);
                correctionArea.classList.remove('hidden');
                correctionArea.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Apply corrections handler
            document.getElementById('apply-corrections').addEventListener('click', function() {
                const editor = document.getElementById('textEditor');
                editor.textContent = correctedText;
                document.getElementById('correction-area').classList.add('hidden');
                document.getElementById('grammar-errors').innerHTML = `
                    <div class="feedback-message" style="border-color: #00FFB3; box-shadow: 0 0 10px #00FFB3;">
                        ✅ Professional corrections applied successfully! Your text has been comprehensively improved.
                    </div>`;
                updateWritingStats();
            });
            
            // Copy corrections handler
            document.getElementById('copy-corrections').addEventListener('click', function() {
                navigator.clipboard.writeText(correctedText).then(function() {
                    const copyButton = document.getElementById('copy-corrections');
                    copyButton.textContent = "Copied!";
                    setTimeout(() => {
                        copyButton.textContent = "Copy Corrected Text";
                    }, 2000);
                });
            });
            
            // Dismiss corrections handler
            document.getElementById('dismiss-corrections').addEventListener('click', function() {
                document.getElementById('correction-area').classList.add('hidden');
            });

            // Enhanced error span handlers with professional tooltips
            document.querySelectorAll('.error').forEach(errorSpan => {
                errorSpan.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const tooltip = this.getAttribute('data-tooltip');
                    const rect = this.getBoundingClientRect();
                    
                    let floatingTooltip = document.getElementById('floating-tooltip');
                    if (!floatingTooltip) {
                        floatingTooltip = document.createElement('div');
                        floatingTooltip.id = 'floating-tooltip';
                        document.body.appendChild(floatingTooltip);
                    }
                    
                    floatingTooltip.style.cssText = `
                        position: fixed;
                        background: rgba(255, 68, 68, 0.95);
                        color: white;
                        padding: 12px;
                        border-radius: 8px;
                        z-index: 1000;
                        max-width: 320px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                        top: ${rect.bottom + window.scrollY + 10}px;
                        left: ${rect.left + window.scrollX}px;
                        font-size: 14px;
                        line-height: 1.4;
                        pointer-events: none;
                        border-left: 4px solid #FF4444;
                    `;
                    floatingTooltip.innerHTML = tooltip.replace(/\n/g, '<br>');
                    floatingTooltip.style.display = 'block';
                    
                    const hideTooltip = (e) => {
                        if (!this.contains(e.target)) {
                            floatingTooltip.style.display = 'none';
                            document.removeEventListener('click', hideTooltip);
                        }
                    };
                    document.addEventListener('click', hideTooltip);
                });
            });
        }

        let timeLeft = 1800; // 30 minutes in seconds
        let timerId = null;
        let isTimerRunning = false;

        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerId = setInterval(updateTimer, 1000);
            }
        }

        function pauseTimer() {
            isTimerRunning = false;
            clearInterval(timerId);
        }

        function resetTimer() {
            pauseTimer();
            timeLeft = 1800;
            updateTimerDisplay();
            document.getElementById('timer').classList.remove('warning');
        }

        function updateTimer() {
            if (timeLeft > 0) {
                timeLeft--;
                updateTimerDisplay();
                
                // Warning when less than 5 minutes remaining
                if (timeLeft <= 300) {
                    document.getElementById('timer').classList.add('warning');
                    
                    // Play beep sound every minute when less than 5 minutes
                    if (timeLeft % 60 === 0) {
                        playBeep();
                    }
                }
            } else {
                pauseTimer();
                playBeep();
                alert('Time is up!');
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        function playBeep() {
            const beep = document.getElementById('timerBeep');
            beep.currentTime = 0;
            beep.play();
        }

        // Add event listener for page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isTimerRunning) {
                // Automatically pause timer when user switches tabs
                pauseTimer();
            }
        });

        function downloadText() {
            const topic = document.getElementById('selectedTopic').innerText;
            const text = document.getElementById('textEditor').innerText;
            const timestamp = new Date().toLocaleString().replace(/[/:]/g, '-');
            
            // Create the content with topic and text
            const content = `Topic: ${topic}\n\nWritten Response:\n${text}`;
            
            // Create blob and download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `french-writing-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Auto-save functionality
        function autoSave() {
            const text = document.getElementById('textEditor').innerText;
            const topic = document.getElementById('selectedTopic').innerText;
            localStorage.setItem('writingDraft', JSON.stringify({
                text,
                topic,
                timestamp: new Date().toISOString()
            }));
            
            // Show autosave indicator
            showAutosaveIndicator();
        }

        function showAutosaveIndicator() {
            const indicator = document.querySelector('.autosave-indicator');
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // Update writing stats
        function updateWritingStats() {
            const text = document.getElementById('textEditor').innerText;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            const readingTime = Math.ceil(words / 200); // Average reading speed

            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
            document.getElementById('readingTime').textContent = readingTime;
        }

        // Add event listeners
        document.getElementById('textEditor').addEventListener('input', () => {
            updateWritingStats();
            // Auto-save after typing stops for 1 second
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(autoSave, 1000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                downloadText();
            }
            // Ctrl/Cmd + Enter to check grammar
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                checkGrammar();
            }
        });

        // Add this function to create typing effect
        function typeMessage(element, text, speed = 50) {
            let i = 0;
            element.innerHTML = '';
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        // Add this function to create particles for the contact form
        function createContactFormParticles() {
            const formIntro = document.querySelector('.form-intro');
            const particleContainer = document.createElement('div');
            particleContainer.className = 'form-particles';
            formIntro.appendChild(particleContainer);

            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = Math.random() * 3 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                const animation = particle.animate([
                    { transform: 'translate(0, 0)', opacity: 0.3 },
                    { transform: `translate(${Math.random() * 30 - 15}px, ${Math.random() * 30 - 15}px)`, opacity: 0 }
                ], {
                    duration: Math.random() * 2000 + 1500,
                    iterations: Infinity
                });
                
                particleContainer.appendChild(particle);
            }
        }

        // Comprehensive writing assessment
        async function assessWriting() {
            const text = document.getElementById('textEditor').innerText;
            const assessmentPanel = document.getElementById('assessmentPanel');
            
            console.log("Starting assessment with text:", text.substring(0, 50) + "...");
            
            // Don't run assessment if text is empty or placeholder
            if (!text || text.trim() === '' || text === 'Type your response in French here...') {
                console.log("Text is empty or placeholder, skipping assessment");
                return;
            }
            
            // Show loading state
            assessmentPanel.classList.remove('hidden');
            showLoadingState();

            try {
                console.log("Analyzing text metrics...");
                // Analyze text metrics
                const metrics = analyzeTextMetrics(text);
                console.log("Text metrics:", metrics);
                
                console.log("Analyzing vocabulary...");
                // Analyze vocabulary
                const vocabAnalysis = analyzeVocabulary(text);
                console.log("Vocabulary analysis:", vocabAnalysis);
                
                console.log("Assessing grammar...");
                // Assess grammar (using existing LanguageTool API)
                const grammarAnalysis = await checkGrammarForAssessment(text);
                console.log("Grammar analysis:", grammarAnalysis);
                
                console.log("Determining CEFR level...");
                // Determine CEFR level
                const level = determineCEFRLevel(metrics, vocabAnalysis, grammarAnalysis);
                console.log("Determined CEFR level:", level);
                
                console.log("Updating assessment UI...");
                // Update UI with results
                updateAssessmentUI(metrics, vocabAnalysis, grammarAnalysis, level);
                console.log("Assessment complete!");
                
            } catch (error) {
                console.error('Assessment error:', error);
                showAssessmentError();
            }
        }

        function analyzeTextMetrics(text) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const words = text.split(/\s+/).filter(w => w.length > 0);
            
            // Handle edge cases better
            const sentenceCount = Math.max(1, sentences.length); // Avoid division by zero
            const wordCount = Math.max(1, words.length); // Avoid division by zero
            
            // Calculate sentence length variation safely
            let sentenceLengthVariation = 0;
            if (sentences.length > 1) {
                const lengths = sentences.map(s => s.split(/\s+/).filter(w => w.length > 0).length);
                sentenceLengthVariation = calculateVariation(lengths);
            }
            
            return {
                averageSentenceLength: wordCount / sentenceCount,
                sentenceLengthVariation: sentenceLengthVariation,
                uniqueWordsRatio: new Set(words.map(w => w.toLowerCase())).size / wordCount,
                textLength: wordCount,
                complexSentences: sentences.filter(s => s.includes(',') || s.includes(';')).length / sentenceCount
            };
        }

        function analyzeVocabulary(text) {
            // This would connect to a French vocabulary database
            // For now, we'll use a simplified version
            const words = text.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            console.log("Total words to analyze:", words.length);
            
            if (words.length === 0) {
                return {
                    advanced: 0,
                    intermediate: 0,
                    basic: 0,
                    uniqueWords: 0,
                    commonPhrases: []
                };
            }
            
            const advanced = countAdvancedWords(words);
            const intermediate = countIntermediateWords(words);
            // Ensure basic words is not negative
            const basic = Math.max(0, words.length - (advanced + intermediate));
            
            return {
                advanced: advanced,
                intermediate: intermediate,
                basic: basic,
                uniqueWords: new Set(words).size,
                commonPhrases: identifyCommonPhrases(text)
            };
        }

        function determineCEFRLevel(metrics, vocab, grammar) {
            // More sophisticated algorithm to determine CEFR level
            let baseScore = 0;
            
            // Factor in text complexity (0-5 points)
            baseScore += metrics.complexSentences * 3;
            baseScore += metrics.uniqueWordsRatio * 2;
            
            // Factor in vocabulary range (0-5 points)
            const vocabRatio = (vocab.advanced + vocab.intermediate) / (vocab.basic || 1);
            baseScore += Math.min(vocabRatio * 2, 3);
            baseScore += (vocab.advanced / (vocab.basic || 1)) * 2;
            
            // Factor in grammar accuracy (0-5 points)
            const errorDensity = grammar.errorCount / (metrics.textLength || 1);
            baseScore -= Math.min(errorDensity * 10, 5);
            
            // Normalize score to 0-1 range
            const normalizedScore = Math.max(0, Math.min(baseScore / 10, 1));
            
            // Factor in sentence complexity and variety
            if (metrics.averageSentenceLength > 15 && metrics.sentenceLengthVariation > 0.3) {
                normalizedScore += 0.1; // Boost for complex sentences
            }
            
            // Factor in text length - longer texts can demonstrate higher proficiency
            if (metrics.textLength > 150) {
                normalizedScore += 0.1;
            }
            
            // Map to CEFR level with expanded ranges
            if (normalizedScore < 0.25) return "A1";
            if (normalizedScore < 0.4) return "A2";
            if (normalizedScore < 0.55) return "B1";
            if (normalizedScore < 0.7) return "B2";
            if (normalizedScore < 0.85) return "C1";
            return "C2";
        }

        function generateDetailedReport() {
            const report = {
                timestamp: new Date().toISOString(),
                text: document.getElementById('textEditor').innerText,
                topic: document.getElementById('selectedTopic').innerText,
                assessment: {
                    level: document.getElementById('assessedLevel').innerText,
                    grammarScore: document.getElementById('grammarScore').style.width,
                    vocabularyScore: document.getElementById('vocabScore').style.width,
                    styleScore: document.getElementById('styleScore').style.width,
                    improvements: Array.from(document.getElementById('improvementList').children)
                        .map(li => li.innerText)
                }
            };

            // Create and download PDF report
            generatePDF(report);
        }

        // French vocabulary levels (simplified version)
        const frenchVocabulary = {
            A1: ['je', 'tu', 'il', 'elle', 'nous', 'vous', 'ils', 'elles', 'être', 'avoir', 'bonjour', 'merci', 'oui', 'non', 'pouvoir', 'vouloir', 'aller', 'manger', 'boire', 'venir', 'faire', 'dire', 'trouver'],
            A2: ['maintenant', 'aujourd\'hui', 'demain', 'hier', 'semaine', 'mois', 'année', 'quelque', 'déjà', 'toujours', 'parfois', 'aussi', 'assez', 'encore', 'beaucoup', 'seulement', 'vraiment'],
            B1: ['cependant', 'néanmoins', 'puisque', 'lorsque', 'pendant', 'durant', 'ainsi', 'autrement', 'par conséquent', 'tandis que', 'voire', 'd\'autant plus', 'quasiment', 'désormais', 'entre-temps'],
            B2: ['effectivement', 'éventuellement', 'précisément', 'particulièrement', 'sous prétexte que', 'quoique', 'toutefois', 'pour autant', 'd\'une part', 'en revanche', 'au préalable'],
            C1: ['systématiquement', 'fondamentalement', 'intrinsèquement', 'envisageable', 'inéluctable', 'subséquemment', 'paradoxalement', 'manifestement', 'inévitablement', 'indubitablement'],
            C2: ['épistémologique', 'paradigmatique', 'ontologique', 'heuristique', 'transcendantal', 'méta-cognitif', 'post-structuraliste', 'herméneutique']
        };

        // CEFR level descriptors
        const cefrDescriptors = {
            A1: {
                grammar: "Can use simple present tense and common verbs in their base form. Limited knowledge of conjugations.",
                vocabulary: "Uses basic everyday words related to immediate needs and personal details.",
                coherence: "Can construct very simple sentences with 'and', 'but', 'then'.",
                discourse: "Mostly isolated phrases or single words."
            },
            A2: {
                grammar: "Can form simple past and future structures, with frequent mistakes.",
                vocabulary: "Uses a basic but broader range of words, including common adverbs and prepositions.",
                coherence: "Can link phrases using common connectors like 'because', 'so', 'but'.",
                discourse: "Uses short sentences but lacks complexity."
            },
            B1: {
                grammar: "Uses subordinate clauses, conditional sentences, and some relative pronouns.",
                vocabulary: "Expands vocabulary to include abstract terms and expressions of time.",
                coherence: "Can structure coherent discourse with a variety of linking words.",
                discourse: "Can narrate events and express opinions with some fluency."
            },
            B2: {
                grammar: "Uses complex sentence structures, including passive voice and reported speech.",
                vocabulary: "Uses a wide range of vocabulary, including idioms and nuanced expressions.",
                coherence: "Maintains logical progression with advanced connectors.",
                discourse: "Can argue and justify opinions clearly."
            },
            C1: {
                grammar: "Uses sophisticated grammatical structures with minor errors.",
                vocabulary: "Employs a wide range of nuanced vocabulary, including technical terms.",
                coherence: "Can express ideas fluently and adapt style to different contexts.",
                discourse: "Can produce detailed and well-structured texts on complex subjects."
            },
            C2: {
                grammar: "Uses advanced syntax and near-native fluency with precision.",
                vocabulary: "Has command of rare, specialized, and academic terminology.",
                coherence: "Speaks and writes effortlessly with a natural flow.",
                discourse: "Can argue and debate complex abstract concepts persuasively."
            }
        };

        // Function to determine CEFR level based on word usage
        function assessLanguageLevel(wordsUsed) {
            let score = { A1: 0, A2: 0, B1: 0, B2: 0, C1: 0, C2: 0 };
            let totalWords = wordsUsed.length;

            // Count occurrences of words in each level
            wordsUsed.forEach(word => {
                let matched = false;
                for (let level of ["C2", "C1", "B2", "B1", "A2", "A1"]) {
                    if (frenchVocabulary[level] && frenchVocabulary[level].includes(word.toLowerCase())) {
                        score[level]++;
                        matched = true;
                        break; // Stop once a match is found (assigning highest applicable level)
                    }
                }
                
                // If no match found, default to A1
                if (!matched) {
                    score.A1++;
                }
            });

            // Calculate percentages
            let percentages = {};
            for (let level in score) {
                percentages[level] = (score[level] / totalWords) * 100;
            }

            // Determine the best level using a weighted system
            let maxLevel = 'A1'; // Default to A1 (most basic)
            
            // Using a more nuanced approach to determine level
            if (percentages['C2'] > 10) maxLevel = 'C2';
            else if (percentages['C1'] > 15) maxLevel = 'C1';
            else if (percentages['B2'] > 20) maxLevel = 'B2';
            else if (percentages['B1'] > 25) maxLevel = 'B1';
            else if (percentages['A2'] > 30) maxLevel = 'A2';
            else maxLevel = 'A1';

            return {
                level: maxLevel,
                description: cefrDescriptors[maxLevel],
                wordDistribution: score,
                confidence: percentages[maxLevel].toFixed(2) + '%'
            };
        }

        // Example Usage
        const sampleWords = ['je', 'merci', 'néanmoins', 'précisément', 'ontologique']; // Mixed levels
        const assessment = assessLanguageLevel(sampleWords);

        console.log(assessment);

        // Add these functions to implement the report generation

        function generatePDF(report) {
            // Format the report data
            const reportText = formatReportAsText(report);
            
            try {
                // Create blob with UTF-8 encoding explicitly specified
                const blob = new Blob([reportText], { 
                    type: 'text/plain;charset=utf-8' 
                });

                // For Safari compatibility, create a temporary link element
                const downloadLink = document.createElement('a');
                
                // Use a more Safari-friendly way to create the object URL
                if (window.webkitURL != null) {
                    // Safari
                    downloadLink.href = window.webkitURL.createObjectURL(blob);
                } else {
                    // Other browsers
                    downloadLink.href = window.URL.createObjectURL(blob);
                }

                // Set download attribute with filename
                const fileName = `french-assessment-${new Date().toISOString().slice(0,10)}.txt`;
                downloadLink.download = fileName;
                
                // Append link, trigger click, and clean up
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // Clean up after small delay to ensure download starts
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    if (window.webkitURL != null) {
                        window.webkitURL.revokeObjectURL(downloadLink.href);
                    } else {
                        window.URL.revokeObjectURL(downloadLink.href);
                    }
                }, 100);

                // Show success message
                const grammarErrors = document.getElementById('grammar-errors');
                if (grammarErrors) {
                    grammarErrors.innerHTML = `
                        <div class="feedback-message">
                            Your detailed assessment report has been downloaded.
                        </div>`;
                }
            } catch (error) {
                console.error('Download error:', error);
                // Show error message
                const grammarErrors = document.getElementById('grammar-errors');
                if (grammarErrors) {
                    grammarErrors.innerHTML = `
                        <div class="feedback-message" style="border-color: #FF4444; box-shadow: 0 0 10px #FF4444;">
                            There was an error generating your report. Please try again.
                        </div>`;
                }
            }
        }

        function formatReportAsText(report) {
            // Format the report data as a readable text document
            return `
=====================================================
  FRENCH WRITING ASSESSMENT REPORT - HEMIYA AI
=====================================================
Date: ${new Date(report.timestamp).toLocaleString()}

TOPIC
-----
${report.topic}

CEFR LEVEL ASSESSMENT
--------------------
Your writing demonstrates proficiency at: ${report.assessment.level} level

SCORE BREAKDOWN
--------------
Grammar & Structure: ${report.assessment.grammarScore}
Vocabulary Usage: ${report.assessment.vocabularyScore}
Style & Coherence: ${report.assessment.styleScore}

IMPROVEMENT SUGGESTIONS
---------------------
${report.assessment.improvements.map(imp => `• ${imp}`).join('\n')}

WRITING SAMPLE
-------------
${report.text}

=====================================================
Generated by Hemiya AI - Your French Writing Coach
=====================================================
`;
        }

        // Add implementation for these missing functions needed by assessWriting()
        function showLoadingState() {
            document.getElementById('grammarScore').style.width = '0%';
            document.getElementById('vocabScore').style.width = '0%';
            document.getElementById('styleScore').style.width = '0%';
            
            document.getElementById('grammarDetails').innerHTML = '<li>Analyzing grammar patterns...</li>';
            document.getElementById('vocabDetails').innerHTML = '<li>Evaluating vocabulary usage...</li>';
            document.getElementById('styleDetails').innerHTML = '<li>Assessing writing style...</li>';
            
            document.getElementById('improvementList').innerHTML = '<li>Preparing recommendations...</li>';
        }

        function showAssessmentError() {
            document.getElementById('assessmentPanel').innerHTML = `
                <div class="feedback-message" style="border-color: #FF4444; box-shadow: 0 0 10px #FF4444;">
                    Error processing assessment. Please try again.
                </div>`;
        }

        function calculateVariation(arr) {
            if (arr.length <= 1) return 0;
            const mean = arr.reduce((sum, val) => sum + val, 0) / arr.length;
            const variance = arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length;
            return Math.sqrt(variance) / mean; // coefficient of variation
        }

        function countAdvancedWords(words) {
            // Count words that appear in C1/C2 vocab lists (was incorrectly using C1/A2)
            let count = 0;
            const advancedWords = [...frenchVocabulary.C1, ...frenchVocabulary.C2];
            console.log("Advanced words to check against:", advancedWords.length);
            words.forEach(word => {
                if (advancedWords.includes(word.toLowerCase())) count++;
            });
            console.log("Advanced words found:", count);
            return count;
        }

        function countIntermediateWords(words) {
            // Count words that appear in B1/B2 vocab lists (was incorrectly using A2/A2)
            let count = 0;
            const intermediateWords = [...frenchVocabulary.B1, ...frenchVocabulary.B2];
            console.log("Intermediate words to check against:", intermediateWords.length);
            words.forEach(word => {
                if (intermediateWords.includes(word.toLowerCase())) count++;
            });
            console.log("Intermediate words found:", count);
            return count;
        }

        function identifyCommonPhrases(text) {
            // This would use n-gram analysis in a real implementation
            // For now, return placeholder data
            return ["de temps en temps", "en ce qui concerne", "à mon avis"];
        }

        function mapScoreToCEFR(score) {
            // Map a numerical score to CEFR level
            if (score < 0.2) return "A1";
            if (score < 0.4) return "A2";
            if (score < 0.6) return "B1";
            if (score < 0.75) return "B2";
            if (score < 0.9) return "C1";
            return "C2";
        }

        async function checkGrammarForAssessment(text) {
            try {
                const response = await fetch('https://api.languagetool.org/v2/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'text': text,
                        'language': 'fr'
                    })
                });

                const data = await response.json();
                return {
                    errorCount: data.matches.length,
                    errors: data.matches.map(match => ({
                        message: match.message,
                        replacement: match.replacements[0]?.value || '',
                        category: match.rule.category.id
                    }))
                };
            } catch (error) {
                console.error('Grammar check error:', error);
                return { errorCount: 0, errors: [] };
            }
        }

        function updateAssessmentUI(metrics, vocabAnalysis, grammarAnalysis, level) {
            // Update level badge
            document.getElementById('assessedLevel').textContent = level;
            
            // Calculate scores based on metrics (0-100%)
            const grammarScore = Math.max(0, Math.min(100, 100 - (grammarAnalysis.errorCount * 5)));
            const vocabScore = Math.max(0, Math.min(100, 
                (vocabAnalysis.uniqueWords / metrics.textLength) * 100 + 
                (vocabAnalysis.advanced / metrics.textLength) * 200
            ));
            const styleScore = Math.max(0, Math.min(100,
                metrics.complexSentences * 50 + 
                metrics.sentenceLengthVariation * 30 + 
                Math.min(metrics.averageSentenceLength / 15, 1) * 20
            ));
            
            // Update progress bars with animation
            animateProgressBar('grammarScore', grammarScore);
            animateProgressBar('vocabScore', vocabScore);
            animateProgressBar('styleScore', styleScore);
            
            // Update score labels
            document.querySelectorAll('.score-label')[0].textContent = `${Math.round(grammarScore)}%`;
            document.querySelectorAll('.score-label')[1].textContent = `${Math.round(vocabScore)}%`;
            document.querySelectorAll('.score-label')[2].textContent = `${Math.round(styleScore)}%`;
            
            // Update details lists
            updateGrammarDetails(grammarAnalysis);
            updateVocabDetails(vocabAnalysis);
            updateStyleDetails(metrics);
            
            // Update vocab counts
            document.getElementById('advancedCount').textContent = vocabAnalysis.advanced;
            document.getElementById('intermediateCount').textContent = vocabAnalysis.intermediate;
            document.getElementById('basicCount').textContent = vocabAnalysis.basic;
            
            // Update metrics
            document.getElementById('sentenceLengthVar').textContent = Math.round(metrics.sentenceLengthVariation * 100) / 100;
            document.getElementById('textCoherence').textContent = Math.round((1 - grammarAnalysis.errorCount / metrics.textLength) * 10) / 10;
            document.getElementById('expressionDiversity').textContent = Math.round(vocabAnalysis.uniqueWords / metrics.textLength * 10) / 10;
            
            // Generate improvement suggestions
            generateImprovementSuggestions(level, grammarAnalysis, vocabAnalysis, metrics);
            
            // Ensure the assessment panel is visible and scrolled into view
            const assessmentPanel = document.getElementById('assessmentPanel');
            assessmentPanel.classList.remove('hidden');
            
            // Scroll the assessment panel into view with a slight delay to ensure UI updates are complete
            setTimeout(() => {
                assessmentPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        function animateProgressBar(id, value) {
            const progressBar = document.getElementById(id);
            let width = 0;
            const interval = setInterval(() => {
                if (width >= value) {
                    clearInterval(interval);
                } else {
                    width += 2;
                    progressBar.style.width = width + '%';
                }
            }, 10);
        }

        function updateGrammarDetails(grammarAnalysis) {
            const grammarDetails = document.getElementById('grammarDetails');
            grammarDetails.innerHTML = '';
            
            if (grammarAnalysis.errorCount === 0) {
                grammarDetails.innerHTML = '<li>No grammatical errors detected. Excellent!</li>';
                return;
            }
            
            // Group errors by category
            const categories = {};
            grammarAnalysis.errors.forEach(error => {
                if (!categories[error.category]) {
                    categories[error.category] = 0;
                }
                categories[error.category]++;
            });
            
            // Create list items for each category
            Object.entries(categories).forEach(([category, count]) => {
                const li = document.createElement('li');
                li.textContent = `${formatCategoryName(category)}: ${count} ${count === 1 ? 'issue' : 'issues'}`;
                grammarDetails.appendChild(li);
            });
        }

        function formatCategoryName(category) {
            // Convert category ID to readable name
            const names = {
                'GRAMMAR': 'Grammar',
                'TYPOS': 'Spelling',
                'PUNCTUATION': 'Punctuation',
                'CASING': 'Capitalization',
                'CONFUSED_WORDS': 'Word confusion',
                'REDUNDANCY': 'Redundancy',
                'STYLE': 'Style',
                'SEMANTICS': 'Semantics'
            };
            return names[category] || category;
        }

        function updateVocabDetails(vocabAnalysis) {
            const vocabDetails = document.getElementById('vocabDetails');
            vocabDetails.innerHTML = '';
            
            vocabDetails.innerHTML += `<li>Unique words: ${vocabAnalysis.uniqueWords}</li>`;
            vocabDetails.innerHTML += `<li>Lexical diversity: ${Math.round(vocabAnalysis.uniqueWords / (vocabAnalysis.advanced + vocabAnalysis.intermediate + vocabAnalysis.basic) * 100)}%</li>`;
            
            if (vocabAnalysis.commonPhrases.length > 0) {
                vocabDetails.innerHTML += `<li>Common phrases used: ${vocabAnalysis.commonPhrases.slice(0, 2).join(', ')}</li>`;
            }
        }

        function updateStyleDetails(metrics) {
            const styleDetails = document.getElementById('styleDetails');
            styleDetails.innerHTML = '';
            
            styleDetails.innerHTML += `<li>Average sentence length: ${Math.round(metrics.averageSentenceLength)} words</li>`;
            styleDetails.innerHTML += `<li>Complex sentences: ${Math.round(metrics.complexSentences * 100)}%</li>`;
            
            // Add style feedback based on metrics
            if (metrics.averageSentenceLength < 5) {
                styleDetails.innerHTML += `<li>Try using longer, more detailed sentences</li>`;
            } else if (metrics.averageSentenceLength > 20) {
                styleDetails.innerHTML += `<li>Consider breaking up some longer sentences</li>`;
            }
            
            if (metrics.sentenceLengthVariation < 0.3) {
                styleDetails.innerHTML += `<li>Try varying your sentence length to create better rhythm</li>`;
            }
        }

        function generateImprovementSuggestions(level, grammarAnalysis, vocabAnalysis, metrics) {
            const improvementList = document.getElementById('improvementList');
            improvementList.innerHTML = '';
            
            // Generate comprehensive and detailed suggestions
            const suggestions = [];
            
            // 📝 GRAMMAR & STRUCTURE IMPROVEMENTS
            if (grammarAnalysis.errorCount > 0) {
                const categories = {};
                grammarAnalysis.errors.forEach(error => {
                    if (!categories[error.category]) {
                        categories[error.category] = 0;
                    }
                    categories[error.category]++;
                });
                
                // Most common error category with detailed advice
                const mostCommonCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
                const categoryName = formatCategoryName(mostCommonCategory[0]);
                suggestions.push(`📝 <strong>${categoryName} Focus:</strong> This was your most frequent error type (${mostCommonCategory[1]} instances). Review ${getDetailedGrammarAdvice(categoryName)} and practice specific exercises.`);
                
                // Error density analysis
                const errorDensity = grammarAnalysis.errorCount / metrics.textLength;
                if (errorDensity > 0.1) {
                    suggestions.push(`🎯 <strong>Accuracy Target:</strong> Your error rate is ${Math.round(errorDensity * 100)}%. Aim to reduce this by proofreading each sentence and checking verb agreements, gender concordance, and article usage.`);
                } else if (errorDensity > 0.05) {
                    suggestions.push(`✨ <strong>Polish Your Writing:</strong> You're doing well with only ${Math.round(errorDensity * 100)}% errors. Focus on the remaining details like prepositions and subtle grammar rules.`);
                }
            } else {
                suggestions.push(`🎉 <strong>Grammar Mastery:</strong> Excellent! No grammar errors detected. Your structural accuracy is impressive for ${level} level.`);
            }
            
            // 📚 VOCABULARY ENHANCEMENT
            const totalWords = vocabAnalysis.advanced + vocabAnalysis.intermediate + vocabAnalysis.basic;
            const advancedRatio = vocabAnalysis.advanced / totalWords;
            const uniqueRatio = vocabAnalysis.uniqueWords / totalWords;
            
            if (advancedRatio < 0.1 && ['B2', 'C1', 'C2'].includes(level)) {
                suggestions.push(`📚 <strong>Vocabulary Sophistication:</strong> Only ${Math.round(advancedRatio * 100)}% of your vocabulary is advanced. For ${level} level, incorporate more nuanced terms, academic vocabulary, and idiomatic expressions. Try reading French literature or newspapers.`);
            } else if (advancedRatio < 0.05 && ['B1'].includes(level)) {
                suggestions.push(`📚 <strong>Expand Your Lexicon:</strong> Challenge yourself with more varied vocabulary. Learn 5 new words daily and try to use synonyms instead of repeating the same terms.`);
            }
            
            if (uniqueRatio < 0.6) {
                suggestions.push(`🔄 <strong>Word Variety:</strong> You repeated words frequently (${Math.round(uniqueRatio * 100)}% unique). Practice using synonyms: instead of "très" try "vraiment, extrêmement, particulièrement". Create a personal synonym dictionary.`);
            } else if (uniqueRatio > 0.8) {
                suggestions.push(`🌟 <strong>Lexical Richness:</strong> Outstanding vocabulary diversity (${Math.round(uniqueRatio * 100)}% unique words)! This shows excellent command of French lexicon.`);
            }
            
            // ✍️ WRITING STYLE & FLOW
            if (metrics.averageSentenceLength < 8 && !['A1', 'A2'].includes(level)) {
                suggestions.push(`✍️ <strong>Sentence Development:</strong> Your average sentence length is ${Math.round(metrics.averageSentenceLength)} words. For ${level} level, aim for 12-15 words per sentence by adding descriptive details, subordinate clauses, and connecting ideas.`);
            } else if (metrics.averageSentenceLength > 20) {
                suggestions.push(`✂️ <strong>Sentence Clarity:</strong> Some sentences are quite long (avg: ${Math.round(metrics.averageSentenceLength)} words). Break complex ideas into clearer, more digestible sentences for better readability.`);
            }
            
            if (metrics.complexSentences < 0.2 && ['B1', 'B2', 'C1', 'C2'].includes(level)) {
                suggestions.push(`🔗 <strong>Complex Structures:</strong> Only ${Math.round(metrics.complexSentences * 100)}% of your sentences use complex structures. Practice with subordinating conjunctions (bien que, puisque, tandis que) and relative pronouns (dont, où, lequel).`);
            } else if (metrics.complexSentences > 0.6) {
                suggestions.push(`🎭 <strong>Structural Sophistication:</strong> Excellent use of complex sentences (${Math.round(metrics.complexSentences * 100)}%)! This demonstrates advanced French syntax mastery.`);
            }
            
            if (metrics.sentenceLengthVariation < 0.3) {
                suggestions.push(`🎵 <strong>Rhythm & Flow:</strong> Your sentences have similar lengths. Create better rhythm by mixing short impact sentences with longer, detailed ones. Vary between 5-word and 15-word sentences.`);
            }
            
            // 🎯 LEVEL-SPECIFIC DETAILED GUIDANCE
            const levelSpecificAdvice = getDetailedCEFRAdvice(level, metrics, vocabAnalysis);
            suggestions.push(...levelSpecificAdvice);
            
            // 📖 CONTENT & COHERENCE
            if (metrics.textLength < 100) {
                suggestions.push(`📏 <strong>Content Development:</strong> Your text is quite concise (${metrics.textLength} words). Develop your ideas further with examples, explanations, and personal experiences to demonstrate deeper linguistic competence.`);
            } else if (metrics.textLength > 300) {
                suggestions.push(`📖 <strong>Comprehensive Response:</strong> Excellent length (${metrics.textLength} words)! You've demonstrated ability to sustain extended discourse in French.`);
            }
            
            // 💡 PRACTICAL STUDY TIPS
            suggestions.push(`💡 <strong>Next Steps:</strong> ${getPersonalizedStudyTips(level, grammarAnalysis, vocabAnalysis, metrics)}`);
            
            // 🌟 ENCOURAGING MESSAGE
            const encouragement = getEncouragingMessage(level, grammarAnalysis.errorCount, metrics.textLength);
            suggestions.push(`🌟 <strong>Motivation:</strong> ${encouragement}`);
            
            // Add all suggestions to the list with proper HTML formatting
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.innerHTML = suggestion;
                li.style.marginBottom = '12px';
                li.style.lineHeight = '1.5';
                improvementList.appendChild(li);
            });
        }

        function getDetailedGrammarAdvice(categoryName) {
            const advice = {
                'Grammar & Agreement': 'subject-verb agreement, gender concordance (le/la), and plural forms',
                'Spelling': 'common French spelling patterns, accents (é, è, ç), and word endings',
                'Punctuation': 'French punctuation rules, especially with dialogue and question marks',
                'Verb Tense': 'tense consistency, passé composé vs imparfait usage, and subjunctive triggers',
                'Articles': 'definite/indefinite articles (le, la, un, une), partitive articles (du, de la)',
                'Style & Flow': 'connecting words, transition phrases, and sentence variety',
                'Word Choice': 'context-appropriate vocabulary and avoiding false friends',
                'Redundancy': 'concise expression and eliminating unnecessary repetition'
            };
            return advice[categoryName] || 'grammar fundamentals';
        }

        function getDetailedCEFRAdvice(level, metrics, vocabAnalysis) {
            const advice = {
                'A1': [
                    '🔤 <strong>A1 Foundation:</strong> Focus on mastering basic verb conjugations (present tense), essential vocabulary (family, numbers, time), and simple sentence structures with "Je suis, j\'ai, il y a".',
                    '📝 <strong>A1 Practice:</strong> Write simple descriptions, practice basic conversations, and learn high-frequency words. Aim for 50-100 words per text.'
                ],
                'A2': [
                    '⚡ <strong>A2 Development:</strong> Expand to past tenses (passé composé, imparfait), future simple, and time expressions (hier, demain, pendant). Practice connecting ideas with "parce que, mais, donc".',
                    '🗣️ <strong>A2 Expression:</strong> Share opinions with "Je pense que", describe experiences, and use comparative forms (plus que, moins que).'
                ],
                'B1': [
                    '🎯 <strong>B1 Advancement:</strong> Master subjunctive in common expressions, conditional tense, and complex time relationships. Practice argumentation with "d\'une part, d\'autre part".',
                    '💭 <strong>B1 Critical Thinking:</strong> Express hypotheses, give detailed explanations, and discuss abstract topics. Aim for 150-250 words with varied sentence structures.'
                ],
                'B2': [
                    '🔄 <strong>B2 Sophistication:</strong> Use advanced connectors (néanmoins, en revanche, par ailleurs), passive voice, and nuanced expressions. Practice formal vs informal registers.',
                    '📊 <strong>B2 Argumentation:</strong> Develop complex arguments, use statistics and examples, synthesize information from multiple sources.'
                ],
                'C1': [
                    '🎓 <strong>C1 Mastery:</strong> Employ subtle linguistic nuances, cultural references, and sophisticated grammatical structures. Use literary tenses (passé simple) when appropriate.',
                    '🌍 <strong>C1 Discourse:</strong> Engage with complex social issues, demonstrate cultural awareness, and adapt style to different contexts and audiences.'
                ],
                'C2': [
                    '👑 <strong>C2 Excellence:</strong> Achieve near-native fluency with idiomatic expressions, wordplay, and implicit meaning. Master all French grammatical subtleties.',
                    '🎨 <strong>C2 Artistry:</strong> Create engaging, persuasive texts with personal style. Demonstrate creativity, humor, and sophisticated cultural knowledge.'
                ]
            };
            return advice[level] || ['Continue practicing to reach the next level!'];
        }

        function getPersonalizedStudyTips(level, grammarAnalysis, vocabAnalysis, metrics) {
            const tips = [
                'Read French news articles daily for 10 minutes',
                'Practice writing one paragraph daily on different topics',
                'Use Anki or similar apps for vocabulary retention',
                'Listen to French podcasts during commutes',
                'Join French conversation groups or language exchanges',
                'Watch French movies with French subtitles',
                'Keep a French diary to practice daily expression'
            ];
            
            // Personalize based on weaknesses
            if (grammarAnalysis.errorCount > 5) {
                return 'Focus on grammar exercises, especially verb conjugations. Use conjugation apps and practice 15 minutes daily.';
            } else if (vocabAnalysis.uniqueWords / (vocabAnalysis.advanced + vocabAnalysis.intermediate + vocabAnalysis.basic) < 0.6) {
                return 'Build vocabulary systematically: learn 5 new words daily, create sentences with them, and review weekly.';
            } else if (metrics.complexSentences < 0.3) {
                return 'Practice complex sentence structures by combining simple sentences using connecting words and relative pronouns.';
            }
            
            return tips[Math.floor(Math.random() * tips.length)] + ' to continue your excellent progress!';
        }

        function getEncouragingMessage(level, errorCount, textLength) {
            const messages = [
                `You're making fantastic progress in French! Every mistake is a learning opportunity that brings you closer to fluency.`,
                `Your dedication to practicing French writing shows tremendous commitment. Keep up this excellent momentum!`,
                `Writing in a foreign language requires courage and you're demonstrating it beautifully. Bravo for your efforts!`,
                `Each text you write strengthens your French skills. You're building something remarkable - don't give up!`,
                `Your French journey is unique and valuable. Celebrate every small victory along the way to fluency!`,
                `The fact that you're actively practicing writing shows you're serious about mastering French. That mindset will take you far!`,
                `Remember: even native speakers make mistakes. What matters is your willingness to learn and improve continuously.`
            ];
            
            let encouragement = messages[Math.floor(Math.random() * messages.length)];
            
            // Add specific positive reinforcement
            if (errorCount === 0) {
                encouragement += ' Your error-free writing demonstrates excellent command of French fundamentals!';
            } else if (errorCount < 3) {
                encouragement += ' With so few errors, you\'re clearly developing strong French instincts!';
            } else if (textLength > 200) {
                encouragement += ' Your ability to express complex ideas in French shows remarkable progress!';
            }
            
            return encouragement;
        }

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            createContactFormParticles();
            // ... existing code ...
        });

        // Add the avatar animation code after your existing JavaScript functions
        // These should be placed before your final DOMContentLoaded event listener

        // Global pulse interval variable
        let pulseInterval;

        // Function to play intro audio and animate avatar when page loads
        function setupIntroAudio() {
            const introAudio = document.getElementById('introAudio');
            const avatar = document.querySelector('.ai-avatar');
            const avatarImg = avatar.querySelector('.avatar-img');
            
            // Make sure audio is properly loaded
            introAudio.load();
            console.log("Audio element set up:", introAudio);
            
            // Function to handle audio playback when avatar is clicked
            function playIntroAudio() {
                console.log("Avatar clicked - trying to play audio");
                
                if (introAudio.paused) {
                    // Force load before playing
                    introAudio.load();
                    
                    // Try to play with promise handling
                    const playPromise = introAudio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            // Audio playback started successfully
                            console.log("Audio started playing from click");
                            startPulsingWithIntervals(avatarImg);
                        }).catch(error => {
                            // Auto-play was prevented
                            console.error("Audio play error:", error);
                            startPulsingWithIntervals(avatarImg);
                        });
                    }
                } else {
                    introAudio.pause();
                    introAudio.currentTime = 0;
                    avatarImg.classList.remove('avatar-vibrating');
                    if (pulseInterval) {
                        clearInterval(pulseInterval);
                    }
                }
            }

            // Handle audio ending
            introAudio.addEventListener('ended', () => {
                console.log("Audio ended");
                avatarImg.classList.remove('avatar-vibrating');
                if (pulseInterval) {
                    clearInterval(pulseInterval);
                }
            });

            // Make avatar clickable for play/pause
            avatar.addEventListener('click', (e) => {
                console.log("Avatar clicked");
                e.preventDefault();
                e.stopPropagation();
                playIntroAudio();
            });
            
            // Check if user is returning (already registered)
            const hasRegistered = localStorage.getItem('userContact');
            if (hasRegistered && !document.getElementById('contactOverlay')) {
                // User is returning and contact form is not showing
                console.log("Returning user detected, will play audio shortly");
                
                // Auto-play for returning users after a short delay
                setTimeout(() => {
                    playAudioWithAnimation();
                }, 1500);
            }
        }

        // Function to create pulsing animation
        function startPulsingWithIntervals(element) {
            let pulseCount = 0;
            
            // Cute emoji array with French-themed ones
            let emojis = ['💬', '🇫🇷', '👋', '😊', '🎉', '🎓', '🤔', '👍', '✨', '🥐', '🧁', '🌟', '🌈', '🦄', '🎵', '🥰'];
            
            // Start initial pulse
            element.classList.add('avatar-vibrating');
            
            // Clear any existing interval
            if (pulseInterval) {
                clearInterval(pulseInterval);
            }
            
            // Add floating particles around the avatar
            createFloatingParticles(element.parentNode);
            
            // Add initial sparkles
            addSparkleEffect(element.parentNode);
            
            // Create a random "talking" effect with cuter animations
            pulseInterval = setInterval(() => {
                pulseCount++;
                
                // Create a pattern of animation
                if (pulseCount % 5 === 0) {
                    // Add sparkle effects randomly around the avatar
                    addSparkleEffect(element.parentNode);
                    
                    // Add a random emoji speech bubble with cuter styling
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    createSpeechBubble(element.parentNode, randomEmoji);
                }
                
                // Occasionally make the avatar do a cute bounce
                if (pulseCount % 15 === 0) {
                    element.style.animation = 'cute-bounce 0.8s cubic-bezier(0.28, 0.84, 0.42, 1) forwards';
                    
                    setTimeout(() => {
                        element.style.animation = '';
                        element.classList.add('avatar-vibrating');
                    }, 1000);
                }
            }, 300);

            // Make sure the audio element knows to stop the animation when it ends
            const introAudio = document.getElementById('introAudio');
            introAudio.addEventListener('ended', () => {
                if (pulseInterval) {
                    clearInterval(pulseInterval);
                }
                element.classList.remove('avatar-vibrating');
                element.style.transform = '';
            });
        }

        // Function to add sparkle effects
        function addSparkleEffect(container) {
            const sparkleCount = Math.floor(Math.random() * 3) + 2;
            
            for (let i = 0; i < sparkleCount; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.classList.add('sparkle');
                    
                    // Random size between 3px and 10px
                    const size = Math.random() * 7 + 3;
                    
                    // Position randomly around the avatar
                    const angle = Math.random() * 360;
                    const distance = Math.random() * 40 + 60; // Distance from center
                    const centerX = 60; // Assuming avatar is 120px wide
                    const centerY = 60; // Assuming avatar is 120px high
                    
                    const x = centerX + distance * Math.cos(angle * Math.PI / 180);
                    const y = centerY + distance * Math.sin(angle * Math.PI / 180);
                    
                    Object.assign(sparkle.style, {
                        width: `${size}px`,
                        height: `${size}px`,
                        left: `${x}px`,
                        top: `${y}px`,
                        background: `radial-gradient(circle, white 20%, ${getRandomColor()} 70%)`,
                        boxShadow: `0 0 ${size/2}px ${size/2}px rgba(255, 255, 255, 0.7)`
                    });
                    
                    container.appendChild(sparkle);
                    
                    // Remove the sparkle after animation completes
                    setTimeout(() => {
                        if (sparkle.parentNode) {
                            container.removeChild(sparkle);
                        }
                    }, 1500);
                }, i * 100); // Stagger the sparkles
            }
        }

        // Function to create speech bubbles
        function createSpeechBubble(container, emoji) {
            const bubble = document.createElement('div');
            bubble.innerHTML = emoji;
            bubble.style.position = 'absolute';
            bubble.style.zIndex = '10';
            
            // Randomize position with more options
            const positions = [
                { top: '-30px', right: '-5px' },
                { top: '-25px', right: '15px' },
                { top: '-20px', left: '-15px' },
                { top: '0px', right: '-35px' },
                { top: '10px', left: '-30px' },
                { top: '-15px', left: '60px' }
            ];
            const position = positions[Math.floor(Math.random() * positions.length)];
            
            Object.assign(bubble.style, {
                ...position,
                fontSize: '28px',
                padding: '5px',
                borderRadius: '50%',
                background: 'rgba(255, 255, 255, 0.2)',
                animation: 'popBubble 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                filter: 'drop-shadow(0 0 5px rgba(0,255,153,0.7))',
                transform: 'scale(0.1)',
                opacity: '0'
            });
            
            container.appendChild(bubble);
            
            // Remove the speech bubble after animation
            setTimeout(() => {
                if (bubble.parentNode) {
                    container.removeChild(bubble);
                }
            }, 1200);
        }

        // Function to create floating particles
        function createFloatingParticles(container) {
            const colors = ['#00FF99', '#00FFCC', '#00CCFF', '#CCFF00', '#FFCC00', '#FF66CC', '#CC99FF'];
            const shapes = ['circle', 'circle', 'star', 'heart', 'circle'];
            
            // Create particles for a vivid effect
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                const size = Math.random() * 12 + 5;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                
                let shapeCSS = 'border-radius: 50%;'; // Default circle
                
                if (shape === 'star') {
                    // Simple star-like shape using clip-path
                    shapeCSS = 'clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);';
                } else if (shape === 'heart') {
                    // Simple heart-like shape
                    shapeCSS = 'transform: rotate(-45deg); border-radius: 50% 50% 0 50%;';
                }
                
                Object.assign(particle.style, {
                    position: 'absolute',
                    width: `${size}px`,
                    height: `${size}px`,
                    backgroundColor: color,
                    top: `${Math.random() * 120}px`,
                    left: `${Math.random() * 120}px`,
                    filter: 'blur(1px)',
                    opacity: '0.7',
                    animation: `float ${Math.random() * 4 + 3}s ease-in-out infinite, twinkle ${Math.random() * 2 + 1}s ease-in-out infinite`,
                    zIndex: '1'
                });
                
                // Apply the shape CSS
                particle.style.cssText += shapeCSS;
                
                container.appendChild(particle);
                
                // Remove particles when audio ends
                const introAudio = document.getElementById('introAudio');
                introAudio.addEventListener('ended', () => {
                    if (particle.parentNode) {
                        container.removeChild(particle);
                    }
                });
            }
        }

        // Helper function to get random colors
        function getRandomColor() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 100%, 75%)`;
        }

        // Update your DOMContentLoaded event listener to include setupIntroAudio
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            createContactFormParticles();
            setupIntroAudio(); // Add this line to initialize the avatar audio
            // ... existing code ...
        });

        // Add this notification function if it doesn't exist yet
        function showNotification(message, type = 'success') {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '15px 25px';
                notification.style.borderRadius = '10px';
                notification.style.color = '#fff';
                notification.style.fontWeight = 'bold';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                notification.style.animation = 'fade-in 0.3s ease-out forwards';
                document.body.appendChild(notification);
            }
            
            // Set notification style based on type
            if (type === 'success') {
                notification.style.backgroundColor = 'rgba(0, 255, 153, 0.8)';
                notification.style.borderLeft = '5px solid #00FF99';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'rgba(255, 68, 68, 0.8)';
                notification.style.borderLeft = '5px solid #FF4444';
            } else if (type === 'info') {
                notification.style.backgroundColor = 'rgba(0, 149, 255, 0.8)';
                notification.style.borderLeft = '5px solid #0095ff';
            }
            
            // Set message and show notification
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'fade-out 0.3s ease-out forwards';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, 4000);
        }

        // Fix for iOS audio playback - add near the top of your JavaScript
        document.addEventListener('touchstart', function() {
            // Create and play a silent audio context
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const audioCtx = new AudioContext();
                // Resume audio context after user interaction
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            }
            
            // Also try to load the audio after user interaction
            const introAudio = document.getElementById('introAudio');
            if (introAudio) {
                introAudio.load();
            }
        }, {once: true});

        // Update your contact form submit button handler
        document.getElementById('submitBtn').addEventListener('click', function(e) {
            console.log("Submit button clicked - form will handle audio after submission");
        });

        // Add this at the top of your script to handle browser autoplay policies
        function setupAudioForAutoplay() {
            // Get references to elements
            const introAudio = document.getElementById('introAudio');
            const avatarImg = document.querySelector('.avatar-img');
            
            // Create a user interaction handler
            const handleUserInteraction = function() {
                // Remove the event listeners once triggered
                document.removeEventListener('click', handleUserInteraction);
                document.removeEventListener('keydown', handleUserInteraction);
                document.removeEventListener('touchstart', handleUserInteraction);
                
                // Load and prepare the audio
                introAudio.load();
                introAudio.muted = true;
                introAudio.play().then(() => {
                    // Successfully started playback
                    introAudio.pause();
                    introAudio.currentTime = 0;
                    introAudio.muted = false;
                    console.log("Audio prepared for autoplay");
                }).catch(error => {
                    console.error("Audio still not playable:", error);
                });
            };
            
            // Add event listeners for user interaction
            document.addEventListener('click', handleUserInteraction);
            document.addEventListener('keydown', handleUserInteraction);
            document.addEventListener('touchstart', handleUserInteraction);
            
            console.log("Audio autoplay preparation complete");
        }

        // Call this function early in your code
        document.addEventListener('DOMContentLoaded', setupAudioForAutoplay);

        // Add this function to go back to topic selection
        function goBackToTopicSelection() {
            document.getElementById('topicSelection').classList.remove('hidden');
            document.getElementById('writingBoard').classList.add('hidden');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            
            // Reset timer when going back to topic selection
            pauseTimer();
            resetTimer();
        }
    </script>
</body>
</html> 
